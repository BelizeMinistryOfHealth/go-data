"use strict";const PdfUtils=require("../pdfDoc"),Async=require("async");let Sharp=null;try{(Sharp=require("sharp")).concurrency(1)}catch(e){Sharp=e,Sharp=null}const pageSize={width:1190,height:840},doc=PdfUtils.createPdfDoc({borderLess:!0,size:"A3"}),splitTypes={horizontal:"horizontal",vertical:"vertical",grid:"grid",auto:"auto"},worker={createImageDocument(e){let{splitFactor:t,splitType:i}=e;(i=splitTypes[i])||(i=splitTypes.auto);let s=Buffer.from(e.imageBase64,"base64");e.imageBase64=null;let r=Sharp(s);r.trim().toBuffer((e,a)=>{s=null;let n=null;n=e?r:Sharp(a),r=null,n.metadata().then(e=>{let i=null,s=null;return e.width/e.height>pageSize.width/pageSize.height?s=pageSize.height*t:i=pageSize.width*t,n.resize(i,s).toBuffer({resolveWithObject:!0})}).then(({data:s,info:r})=>{const a=Sharp(s);a.limitInputPixels(!1),a.sequentialRead(!0);const n=r.width,h=r.height;let o,l,c,d;i===splitTypes.auto?(d=Math.ceil(n/pageSize.width),c=Math.ceil(h/pageSize.height),o=pageSize.width,l=pageSize.height):([splitTypes.grid,splitTypes.vertical].includes(i)?(l=h/t,c=t):(l=h,c=1),[splitTypes.grid,splitTypes.horizontal].includes(i)?(o=n/t,d=t):(o=n,d=1));let p=!0;const u=Async.queue((t,i)=>{a.extract({left:t.offsetWidth,top:t.offsetHeight,width:t.width,height:t.height}).toBuffer().then(t=>e?i(e):(p||doc.addPage(),p=!1,doc.image(t,0,0,{fit:[pageSize.width,pageSize.height]}),doc.addTransparentLogo(),i())).catch(i)},1);u.drain=function(){process.send([null,{done:!0}])},u.error=function(e){u.kill(),process.send([{error:e.message}])};for(let e=0;e<c;e++)for(let t=0;t<d;t++){let i=e*l,s=t*o,r=Math.min(Math.max(0,n-s),o),a=Math.min(Math.max(0,h-i),l);r&&a&&u.push({offsetWidth:s,offsetHeight:i,width:r,height:a})}}).catch(e=>process.send([{error:e.message}]))})},finish(){doc.end()}};let buffers=[],end=!1;!function e(){buffers.length&&(process.send([null,{chunk:Buffer.concat(buffers)}]),buffers=[]),end?process.send([null,{end:!0}]):setTimeout(e,1e3)}(),doc.on("data",function(e){buffers.push(e)}),doc.on("end",function(){end=!0}),process.on("message",function(e){worker[e.fn](...e.args)});