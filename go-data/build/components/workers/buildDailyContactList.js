"use strict";const PdfUtils=require("../pdfDoc"),Moment=require("moment"),GenericHelpers=require("../helpers"),Async=require("async"),FOLLOWUP_DATE_ID_FORMAT="YYYY-MM-DD",buildTableForContact=function(e,t,o){let n=[],a=!1,d=1,r=function(){n.push({headers:[],values:[]})};const l=t.followUp,s=GenericHelpers.getDate(l.startDate),i=GenericHelpers.getDateEndOfDay(l.endDate);for(let e=s.clone();e.isSameOrBefore(i);e.add(1,"day")){t.followUps.find(t=>Moment(t.date).isSame(e,"day"))||t.followUps.push({date:e.clone()})}t.followUps=t.followUps.sort((e,t)=>Moment.utc(e.date).diff(Moment.utc(t.date))),t.followUps.forEach(l=>{let s=Moment(l.date);const i=s.format("YYYY-MM-DD");if(t[i]={value:o[l.statusId]||"",isDate:!0},d<=24&&!a&&(e.push({id:s.format("YYYY-MM-DD"),header:s.format("YY/MM/DD"),width:20,isDate:!0}),24===d))return a=!0,void(d=1);if(d<=39&&a){if(n.length||r(),n[n.length-1].headers.push({id:s.format("YYYY-MM-DD"),header:s.format("YY/MM/DD"),width:20}),39===d)return r(),void(d=1)}d++}),delete t.followUps;let c=e.filter(e=>e.hasOwnProperty("isDate"));if(c.length){let e=GenericHelpers.convertToDate(c[c.length-1].id);for(let o in t)if(t.hasOwnProperty(o)&&t[o].isDate){let a=GenericHelpers.convertToDate(o);if(a.isAfter(e)){let e=n.filter(e=>{if(e.headers.length){let t=e.headers[e.headers.length-1].id;return a.isSameOrBefore(GenericHelpers.convertToDate(t))}return!1});e.length&&(e[0].values[0]=e[0].values[0]||{},e[0].values[0][o]=t[o].value),delete t[o]}else t[o]=t[o].value}}return{main:{headers:e,data:[t]},additional:n}},doc=PdfUtils.createPdfDoc({fontSize:6,layout:"landscape",margin:20,lineGap:0,wordSpacing:0,characterSpacing:0,paragraphGap:0});doc.on("pageAdded",()=>{doc.moveDown(2)});const worker={sendData(e,t,o,n){if(e.startDocument){PdfUtils.addTitle(doc,e.startDocument.title),doc.moveDown(),PdfUtils.addTitle(doc,e.startDocument.legend.title,12);for(let t in e.startDocument.legend.values)PdfUtils.addTitle(doc,`${t} = ${e.startDocument.legend.values[t]}`,8);doc.moveDown(2)}else doc.addPage();PdfUtils.addTitle(doc,`${e.groupTitle}: ${o.name}`,14),doc.moveDown();const a=doc.x,d=o.records.map(e=>(function(o){setImmediate(()=>{const d=buildTableForContact(t.slice(),e,n);PdfUtils.createTableInPDFDocument(d.main.headers,d.main.data,doc,null,!0),doc.x=a,d.additional.forEach(e=>{PdfUtils.createTableInPDFDocument(e.headers,e.values,doc,null,!0),doc.x=a}),doc.x=a,doc.moveDown(),o()})}));Async.parallelLimit(d,100,function(){doc.moveDown(),PdfUtils.addTitle(doc,`${e.totalTitle}: ${o.records.length}`,12),process.send([null,{readyForNextBatch:!0}])})},finish(){doc.end()}};let buffers=[],end=!1;!function e(){buffers.length&&(process.send([null,{chunk:Buffer.concat(buffers)}]),buffers=[]),end?process.send([null,{end:!0}]):setTimeout(e,1e3)}(),doc.on("data",function(e){buffers.push(e)}),doc.on("end",function(){end=!0}),process.on("message",function(e){worker[e.fn](...e.args)});