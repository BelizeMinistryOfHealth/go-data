"use strict";const _=require("lodash"),helpers=require("../helpers");function addEntryToIndexWithId(e,n,t){e[n]||(e[n]={_ids:{},records:[]}),e[n]._ids[t._id]||(e[n].records.push(t),e[n]._ids[t._id]=!0)}function getEntryId(e,n){let t="",o=!0;return n.forEach(function(n){const r=_.get(e,n);null==r||""===r||"string"==typeof r&&""===r.trim()?o=!1:t+=r.toString().trim().toLowerCase()}),o?t:""}function addEntryToIndex(e,n,t,o){let r=getEntryId(n,t),d=o?getEntryId(n,[...t].reverse()):"";r.length&&(r=`${"string"==typeof n.type?n.type.toLowerCase():"unknown_type"}${r}`,(d=d?`${"string"==typeof n.type?n.type.toLowerCase():"unknown_type"}${d}`:d)&&e[d]?addEntryToIndexWithId(e,d,n):addEntryToIndexWithId(e,r,n))}const worker={findOrCount:function(e,n,t){const o={name:{},documents:{},phoneNumber:{}};e.forEach(function(e){"LNG_REFERENCE_DATA_CATEGORY_PERSON_TYPE_EVENT"===e.type&&e.name&&addEntryToIndex(o.name,e,["name"]),addEntryToIndex(o.name,e,["firstName","lastName"],!0),addEntryToIndex(o.name,e,["firstName","middleName"],!0),addEntryToIndex(o.name,e,["middleName","lastName"],!0),Array.isArray(e.documents)&&e.documents.forEach(function(n,t){addEntryToIndex(o.documents,e,[`documents.${t}.type`,`documents.${t}.number`])})});let r=[];if(Object.keys(o).forEach(function(e){Object.keys(o[e]).forEach(function(n){o[e][n].records.length>1&&r.push({duplicateKey:e,indexKey:n,people:o[e][n].records})})}),t)return r.length;const d={peopleMap:{},groups:[]};return helpers.paginateResultSet(n,r).forEach(function(e){const n={duplicateKey:e.duplicateKey,indexKey:e.indexKey,peopleIds:[]};e.people.forEach(function(e){n.peopleIds.push(e._id),d.peopleMap[e._id]||(d.peopleMap[e._id]=e,e.id=e._id)}),d.groups.push(n)}),d},find:function(e,n){return this.findOrCount(e,n)},count:function(e){return this.findOrCount(e,{},!0)}};process.on("message",function(e){let n=worker[e.fn](...e.args);process.send([null,n])});