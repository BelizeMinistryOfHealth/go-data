"use strict";const PdfKit=require("pdfkit"),PdfTable=require("voilab-pdf-table"),streamUtils=require("./streamUtils"),Jimp=require("jimp"),_=require("lodash"),MIME_TYPE="application/pdf",STANDARD_UNDERLINE_COUNT=40,STANDARD_PAGE_TITLE=20,MAX_QUESTIONS_LEVEL=4,LABEL_LINE_GAP=.3,defaultDocumentConfiguration={size:"A4",autoFirstPage:!1,layout:"landscape",widthForPageSize:841,margin:30,fontSize:8,lineWidth:1,compress:!1};function addPageNumber(e){void 0===e.pageNumber&&(e.pageNumber=0),e.pageNumber++;const t=e.page.margins.bottom;e.page.margins.bottom=0,e.text(e.pageNumber,e.page.width-100,e.page.height-35,{width:100,align:"center",lineBreak:!1}),e.text("",30,50),e.page.margins.bottom=t}function createPdfDoc(e){e=Object.assign({},defaultDocumentConfiguration,e);const t=new PdfKit(e);return t.on("pageAdded",function(){this.lineWidth(e.lineWidth),this.fontSize(e.fontSize),this.font(`${__dirname}/../resources/fonts/NotoSansCJKjp-Regular.min.ttf`),e.borderLess?t.once("addTransparentLogo",function(){this.image(`${__dirname}/../resources/images/logo-black-transparent.png`,15,15,{height:25}),addPageNumber(t)}):(this.image(`${__dirname}/../resources/images/logo-black.png`,t.options.margin,15,{height:25}),addPageNumber(t))}),t.addPage(e),t.addTransparentLogo=function(){this.emit("addTransparentLogo")},t}function createPDFList(e,t,i,o){const n={};switch(!0){case e.length<=10:n.size="A4",n.widthForPageSize=841;break;case e.length>10&&e.length<=20:n.size="A3",n.widthForPageSize=1190;break;case e.length>20&&e.length<=30:n.size="A2",n.widthForPageSize=1683;break;case e.length>30&&e.length<=40:n.size="A1",n.widthForPageSize=2383;break;case e.length>40&&e.length<=50:n.size="A0",n.widthForPageSize=3370;break;case e.length>50&&e.length<=60:n.size="2A0",n.widthForPageSize=4767;break;case e.length>60:n.size="4A0",n.widthForPageSize=6740}const a=createPdfDoc(n);addTitle(a,i,20),createTableInPDFDocument(e,t,a,n),streamUtils.streamToBuffer(a,o),a.end()}const createImageDoc=function(e,t,i,o){const n={horizontal:"horizontal",vertical:"vertical",grid:"grid",auto:"auto"};(i=n[i])||(i=n.auto);const a=createPdfDoc({borderLess:!0,size:"A3"}),r={width:1190,height:840};var s;t=!t||t<1?1:parseInt(t),streamUtils.streamToBuffer(a,o),(s=e,new Promise(function(e){e(Buffer.from(s,"base64"))})).then(function(e){Jimp.read(e).then(function(e){if(!e)return o(new Error("Unknown image format."));let s,l,d,c;e.bitmap.width/e.bitmap.height>r.width/r.height?e.resize(Jimp.AUTO,r.height*t):e.resize(r.width*t,Jimp.AUTO),i===n.auto?(c=Math.ceil(e.bitmap.width/r.width),d=Math.ceil(e.bitmap.height/r.height),s=r.width,l=r.height):([n.grid,n.vertical].includes(i)?(l=e.bitmap.height/t,d=t):(l=e.bitmap.height,d=1),[n.grid,n.horizontal].includes(i)?(s=e.bitmap.width/t,c=t):(s=e.bitmap.width,c=1));let u=[];for(let t=0;t<d;t++)for(let i=0;i<c;i++){let o=t*l,n=i*s,a=Math.min(Math.max(0,e.bitmap.width-n),s),r=Math.min(Math.max(0,e.bitmap.height-o),l);a&&r&&u.push(e.clone().crop(n,o,a,r))}let f=!0;!function e(t){const i=u.shift();i?(f||a.addPage(),f=!1,i.getBuffer(Jimp.MIME_PNG,function(i,o){if(i)return t(i);a.image(o,0,0,{fit:[r.width,r.height]}),a.addTransparentLogo(),e(t)})):t()}(function(e){if(e)return o(e);a.end()})})}).catch(o)},addTitle=function(e,t,i,o){(o=o||{}).x=o.x||e.x,o.y=o.y||e.y;let n=e._fontSize;e.fontSize(i||20),e.text(t,o.x,o.y),e.fontSize(n).moveDown(.5)},createQuestionnaire=function(e,t,i,o,n){(n=n||{}).underlineCount=n.underlineCount||25,n.titleSize=n.titleSize||20,n.titlePosition=n.titlePosition||{};const a=e.x;return o&&addTitle(e,o,n.titleSize,n.titlePosition),e.x=a,e.moveDown(2),function t(o,r,s){o.forEach(o=>{if(s>4)return;let l=a;r&&(l=r+15);const d="LNG_OUTBREAK_QUESTIONNAIRE_ANSWERS_DISPLAY_ORIENTATION_VERTICAL"===o.answersDisplay;if("LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_MARKUP"!==o.answerType)if(e.moveDown().text(`${o.order}. ${o.question}`,l),o.multiAnswers)o.multiAnswers.forEach((a,r)=>{const c=r+1;switch(o.answerType){default:e.moveDown(.5),i?a.value?e.text(`Answer ${c} (${a.date}): ${a.value}`,l):e.text("Answer: ",l):e.text(`Answer: ${"_".repeat(n.underlineCount)}`,l),e.moveDown(.5);break;case"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_FILE_UPLOAD":break;case"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_SINGLE_ANSWER":case"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_MULTIPLE_ANSWERS":let r=!0;const u=function(e,t){return t?e.y-5:e.y};let f=l;d?e.moveDown():e.moveDown(.5);let h=e.x;e.text(`Answer ${c} (${a.date})`,l),e.moveDown(),a.answers.forEach(o=>{r||(d?e.moveDown():f=h+10);let n=e.widthOfString(o.label);if(!d){f+n+45>500&&(f=l,e.moveDown(1.5))}const a=u(e,d);i&&o.selected?e.rect(f,a,10,10).moveTo(f,a).lineTo(f+10,a+10).moveTo(f+10,a).lineTo(f,a+10).stroke():e.rect(f,a,10,10).stroke(),e.text(o.label,f+15,a),h=f+n+15,e.moveUp(),d&&e.moveDown(),o.additionalQuestions.length&&(e.moveDown(.5),t(o.additionalQuestions,l,s+1)),r=!1}),d?e.moveDown(.5):e.moveDown()}});else switch(o.answerType){default:e.moveDown(.5),i?o.value?e.text("Answer: "+o.value,l):e.text("Answer: ",l):e.text(`Answer: ${"_".repeat(n.underlineCount)}`,l),e.moveDown(.5);break;case"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_FILE_UPLOAD":break;case"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_SINGLE_ANSWER":case"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_MULTIPLE_ANSWERS":let a=!0;const r=function(e,t){return t?e.y-5:e.y};let c=l;d?e.moveDown():e.moveDown(.5);let u=e.x;o.answers.forEach(o=>{a||(d?e.moveDown():c=u+10);let n=e.widthOfString(o.label);if(!d){c+n+45>500&&(c=l,e.moveDown(1.5))}const f=r(e,d);i&&o.selected?e.rect(c,f,10,10).moveTo(c,f).lineTo(c+10,f+10).moveTo(c+10,f).lineTo(c,f+10).stroke():e.rect(c,f,10,10).stroke(),e.text(o.label,c+15,f),u=c+n+15,e.moveUp(),d&&e.moveDown(),o.additionalQuestions.length&&(e.moveDown(.5),t(o.additionalQuestions,l,s+1)),a=!1}),d?e.moveDown(.5):e.moveDown()}else e.moveDown().text(`${o.question}`,l)})}(t,!1,0),e},displayModelDetails=function(e,t,i,o,n){n=n||2,o&&(addTitle(e,o,14),e.moveDown());const a=e.x;return Object.keys(t).forEach(o=>{if(Array.isArray(t[o])&&t[o][0]){if(e.text(o,a).moveDown(),i)t[o].forEach((t,i,o)=>{Object.keys(t).forEach(i=>{Array.isArray(t[i])?t.prop.forEach(t=>{e.text(i,a+20).moveDown(),e.x+=20,displayModelDetails(e,t,!0),e.x=a+20}):"object"==typeof t[i]&&null!==t[i]?(e.text(i,a+20).moveDown(),e.x+=20,displayModelDetails(e,t[i],!0)):e.text(`${i}: ${t[i]||0===t[i]||!1===t[i]?t[i]:""}`,a+20).moveDown()}),i!==o.length-1&&e.moveDown(2)});else{let i=Object.keys(t[o][0]),r=new Array(n);r.fill(i),r.forEach((t,i,o)=>{t.forEach(t=>{e.text(`${t}: ${"_".repeat(50)}`,a+20).moveDown()}),i!==o.length-1&&e.moveDown(2)})}e.x=a}else"object"==typeof t[o]&&null!==t[o]&&Object.keys(t[o]).length?(e.text(o,a).moveDown(),e.x+=20,displayModelDetails(e,t[o],!0)):e.text(`${o}: ${i?t[o]||0===t[o]||!1===t[o]?t[o]:"":"_".repeat(50)}`,a).moveDown()}),e},displayPersonRelationships=function(e,t,i){t&&Array.isArray(t)&&t.forEach((t,o)=>{e.addPage(),displayModelDetails(e,t,!0,0===o?i:null)})},displayPersonSectionsWithQuestionnaire=function(e,t,i,o){t&&Array.isArray(t)&&t.forEach(t=>{e.addPage(),displayModelDetails(e,_.omit(t,"questionnaire"),!0,i),t.questionnaire&&t.questionnaire.length&&(e.addPage(),createQuestionnaire(e,t.questionnaire,!0,o))})};function createTableInPDFDocument(e,t,i,o,n,a){t=t.filter(e=>null!=e),o=o||defaultDocumentConfiguration;const r=new PdfTable(i);r.setColumnsDefaults({headerBorder:"B",align:"left",headerPadding:[2],padding:[2],fill:!0}),r.onCellBackgroundAdd(function(e,t,i,o){o%2==0?e.pdf.fillColor("#ececec"):e.pdf.fillColor("#ffffff")}),r.onCellBackgroundAdded(function(e){e.pdf.fillColor("#000000")}),r.onPageAdded(function(e){n||e.addHeader()});let s=0,l=0;e.forEach(function(e){e.width&&(s+=e.width,l++)});const d=(o.widthForPageSize-2*i.options.margin-s)/(e.length-l);e.forEach(function(e){r.addColumn({id:e.id,header:e.header,width:e.width||d})}),t.forEach((e,i)=>{t[i]=_.mapValues(e,e=>"boolean"==typeof e?e.toString():e)}),a?function e(t,o=!0){setImmediate(function(){0===t.length?(i.moveDown(),i.x=i.options.margin,a()):(r.showHeaders=o,r.addBody(t.slice(0,100)),e(t.slice(100),!1))})}(t):(r.addBody(t),i.moveDown(),i.x=i.options.margin)}const downloadPdfDoc=function(e,t,i){const o=require("../server/server");streamUtils.streamToBuffer(e,(e,n)=>{if(e)return i(e);o.utils.remote.helpers.offerFileToDownload(n,MIME_TYPE,`${t}.pdf`,i)})},displayValue=function(e){return null==e?"":e},displaySections=function(e,t,i,o){(o=o||{}).underlineCount=o.underlineCount||40,o.titleSize=o.titleSize||20,o.titlePosition=o.titlePosition||{},o.lineGap=o.lineGap||.3;const n=e.x;i&&(addTitle(e,i,o.titleSize,o.titlePosition),e.moveDown()),e.x=n;const a=n+20;let r=0;Object.keys(t).forEach(i=>{t[i].labels&&t[i].labels.forEach(t=>{const i=e.widthOfString(t);i>r&&(r=i)})});return Object.keys(t).forEach(i=>{e.x=n,addTitle(e,t[i].title,16),((t,i=[],s)=>{s=s||1;for(let l=0;l<s;l++)e.x=n,i[l]&&addTitle(e,i[l],10),t.forEach(t=>{let i=t,n=null;"object"==typeof t&&(i=t.name,n=t.value);const s=e.widthOfString(i),l=r-s,d=e.heightOfString(i);e.text(i,a),e.text(n||"_".repeat(o.underlineCount),a+s+20+l,e.y-d),e.moveDown(o.lineGap)}),e.moveDown()})(t[i].labels,t[i].additionalTitles||[],t[i].copies)}),e},displayResourceLabels=function(e,t,i,o){(o=o||{}).underlineCount=o.underlineCount||40,o.titleSize=o.titleSize||20,o.titlePosition=o.titlePosition||{},o.lineGap=o.lineGap||.3;const n=e.x;i&&(addTitle(e,i,o.titleSize,o.titlePosition),e.moveDown()),e.x=n;const a=n;let r=0;return t.forEach(t=>{const i=e.widthOfString(t);i>r&&(r=i)}),t.forEach(t=>{const i=e.widthOfString(t),n=r-i,s=e.heightOfString(t);e.text(t,a),e.text("_".repeat(o.underlineCount),a+i+20+n,e.y-s),e.moveDown(o.lineGap)}),e},displayAge=function(e,t){let i="",o=_.get(e,"age.years",0),n=_.get(e,"age.months",0);return i=n>0?`${displayValue(n)} ${t.getTranslation("LNG_AGE_FIELD_LABEL_MONTHS")}`:`${displayValue(o)} ${t.getTranslation("LNG_AGE_FIELD_LABEL_YEARS")}`};module.exports={createPDFList:createPDFList,createImageDoc:createImageDoc,createPdfDoc:createPdfDoc,createQuestionnaire:createQuestionnaire,displayModelDetails:displayModelDetails,displayPersonRelationships:displayPersonRelationships,displayPersonSectionsWithQuestionnaire:displayPersonSectionsWithQuestionnaire,createTableInPDFDocument:createTableInPDFDocument,addTitle:addTitle,MIME_TYPE:MIME_TYPE,downloadPdfDoc:downloadPdfDoc,displayValue:displayValue,displaySections:displaySections,displayResourceLabels:displayResourceLabels,displayAge:displayAge};