"use strict";const helpers=require("./helpers"),formidable=require("formidable"),apiError=require("./apiError"),path=require("path"),_=require("lodash");function offerFileToDownload(e,r,t,n){n(null,e,r,`attachment;filename=${helpers.getAsciiString(path.basename(t))}`)}function parseMultipartRequest(e,r,t,n,i,o){(new formidable.IncomingForm).parse(e,function(e,a,s){if(e)return o(e);let l=[];if(r.forEach(function(e){a[e]||-1!==i.indexOf(e)||l.push(e)}),t.forEach(function(e){s[e]||l.push(e)}),l.length)return o(apiError.getError("MISSING_REQUIRED_PROPERTY",{model:n.modelName,properties:l.join(", ")}));o(null,a,s)})}function exportFilteredModelsList(e,r,t,n,i,o,a,s,l,p,d){let u=e=>Promise.resolve(e);p=p||u,d||(d=p,p=u);let c=[];r.rawFind(n).then(function(n){n.forEach(function(e){helpers.covertAddressesGeoPointToLoopbackFormat(e)}),!t.questionnaireAnswers&&l.questionnaire&&(t.questionnaireAnswers=helpers.retrieveQuestionnaireVariables(l.questionnaire,"questionnaireAnswers",l.dictionary,l.useQuestionVariable,helpers.getQuestionnaireMaxAnswersMap(l.questionnaire,n))),c=t?Object.keys(t):[],i=i?i.toLowerCase():"json";const u=r.hasOwnProperty("arrayProps"),f=["json","xml"].includes(i),h=e.utils.remote.getUserFromOptions(l);let L=null;!f&&u&&(L=helpers.getMaximumLengthForArrays(n,Object.keys(r.arrayProps))),e.models.language.getLanguageDictionary(h.languageId,function(l,h){if(l)return d(l);helpers.attachParentLocations(r,e.models.location,n,(l,g)=>{let E=0;l||(n=(g=g||{}).records||n,E=g.highestParentsChain||0);const O=[],$=r.helpers&&r.helpers.sanitizeFieldLabelsMapForExport?r.helpers.sanitizeFieldLabelsMapForExport():r.fieldLabelsMap;let F=Object.keys($),m=[];r.exportFieldsOrder?(m=[...r.exportFieldsOrder],r.exportFieldsOrder.length!==F.length&&m.push(...F.filter(e=>-1===r.exportFieldsOrder.indexOf(e)))):m=[...F],m.forEach(function(e){if(!f&&u&&r.arrayProps[e]){const t=$[e],n=r.arrayProps[e];let o=L[e];"pdf"===i&&(o=1);for(let i=1;i<=o;i++)for(let o in n)if(O.push({id:`${e} ${i} ${o.replace(/\./g," ")}`,header:`${t?h.getTranslation(t)+" ":""}${h.getTranslation(n[o])} [${i}]`}),r.locationFields&&-1!==r.locationFields.indexOf(`${e}[].${o}`))for(let r=1;r<=E;r++)O.push({id:`${e} ${i} ${o}_parentLocations ${r}`,header:`${t?h.getTranslation(t)+" ":""}${h.getTranslation(n[o])} [${i}] ${h.getTranslation("LNG_OUTBREAK_FIELD_LABEL_LOCATION_GEOGRAPHICAL_LEVEL")} [${r}]`})}else if(!(!f&&e.indexOf("[]")>-1&&u))if(!f&&e.indexOf("[]")>-1){let r;const t=e.indexOf(".");if(t>=-1){const n=e.substr(0,t);r=$[n]}let n=3;"pdf"===i&&(n=1);for(let t=1;t<=n;t++)O.push({id:e.replace("[]",` ${t}`).replace(/\./g," "),header:`${r?h.getTranslation(r)+" ":""}${h.getTranslation($[e])}${/\[]/.test(e)?" ["+t+"]":""}`})}else if(!f&&t&&t[e])O.push(...t[e]);else{let t=h.getTranslation($[e]);if(!f){let r;const n=e.indexOf(".");if(n>=-1){const t=e.substr(0,n);r=$[t]}r&&(t=h.getTranslation(r)+" "+t)}if(O.push({id:f?e:e.replace(/\./g," "),header:t}),r.locationFields&&-1!==r.locationFields.indexOf(e))if(f)O.push({id:`${e}_parentLocations`,header:`${t} ${h.getTranslation("LNG_LOCATION_FIELD_LABEL_PARENT_LOCATION")}`});else for(let r=1;r<=E;r++)O.push({id:`${e.replace(/\./g," ")}_parentLocations ${r}`,header:`${t} ${h.getTranslation("LNG_OUTBREAK_FIELD_LABEL_LOCATION_GEOGRAPHICAL_LEVEL")} [${r}]`})}}),helpers.resolveModelForeignKeys(e,r,n,h).then(function(e){return p(e,h)}).then(function(e){return f&&c.forEach(r=>{const n={};(t[r]||[]).forEach(e=>{n[e.expandKey?e.expandKey:e.id]=e.expandHeader?e.expandHeader:e.header}),(e||[]).forEach(e=>{if(e[r]&&_.isObject(e[r])&&!_.isEmpty(e[r])){const t={};Object.keys(e[r]).forEach(i=>{void 0!==n[i]?t[n[i]]=e[r][i]:t[i]=e[r][i]}),e[r]=t}})}),e}).then(function(r){return s.length&&e.utils.anonymizeDatasetFields.anonymize(r,s),r}).then(function(r){return e.utils.helpers.exportListFile(O,r,i)}).then(function(r){return a?e.utils.aesCrypto.encrypt(a,r.data).then(function(e){return r.data=e,r}):r}).then(function(r){e.utils.remote.helpers.offerFileToDownload(r.data,r.mimeType,`${o}.${r.extension}`,d)}).catch(d)})})}).catch(d)}module.exports={offerFileToDownload:offerFileToDownload,parseMultipartRequest:parseMultipartRequest,exportFilteredModelsList:exportFilteredModelsList};