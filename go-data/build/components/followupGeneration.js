"use strict";const App=require("../server/server"),RoundRobin=require("rr"),Helpers=require("./helpers"),Moment=require("moment"),_=require("lodash"),PromiseQueue=require("p-queue"),_createFollowUpEntry=function(e,t){return e.index=Helpers.getDaysSince(Moment(t.followUp.startDate),e.date)+1,e.address=App.models.person.getCurrentAddress(t),e};module.exports.getContactsEligibleForFollowup=function(e,t,o,n){return App.models.contact.rawFind({$and:[{outbreakId:o},{id:{$in:n}},{followUp:{$ne:null}},{"followUp.status":"LNG_REFERENCE_DATA_CONTACT_FINAL_FOLLOW_UP_STATUS_TYPE_UNDER_FOLLOW_UP"},{$or:[{$and:[{"followUp.startDate":{$lte:e}},{"followUp.endDate":{$gte:t}}]},{$and:[{"followUp.startDate":{$gte:e}},{"followUp.startDate":{$lte:t}},{"followUp.endDate":{$gte:t}}]},{$and:[{"followUp.startDate":{$lte:e}},{"followUp.endDate":{$gte:e}},{"followUp.endDate":{$lte:t}}]},{$and:[{"followUp.startDate":{$gte:e}},{"followUp.endDate":{$gte:e}},{"followUp.endDate":{$lte:t}}]}]}]})},module.exports.getContactFollowups=function(e,t,o){return App.models.followUp.rawFind({personId:{$in:o},$and:[{date:{$gte:e}},{date:{$lte:t}}]},{projection:{_id:1,date:1,personId:1,statusId:1}}).then(e=>_.groupBy(e,e=>e.personId))},module.exports.getAllTeamsWithLocationsIncluded=function(){return App.models.team.find().then(e=>Promise.all(e.map(e=>new Promise((t,o)=>App.models.location.getSubLocations(e.locationIds||[],[],(e,n)=>e?o(e):t(n))).then(t=>(e.locations=t,e)))))},module.exports.getContactFollowupEligibleTeams=function(e,t){let o=[];e.addresses=e.addresses||[];let n=e.addresses.find(e=>"LNG_REFERENCE_DATA_CATEGORY_ADDRESS_TYPE_USUAL_PLACE_OF_RESIDENCE"===e.typeId);if(n){let e=t.filter(e=>-1!==e.locations.indexOf(n.locationId));e.length&&(o=e.map(e=>e.id))}else for(let n=0;n<e.addresses.length;n++){let l=t.filter(t=>-1!==t.locations.indexOf(e.addresses[n].locationId));if(l.length){o=o.concat(l.map(e=>e.id));break}}return Promise.resolve(o)},module.exports.generateFollowupsForContact=function(e,t,o,n,l,r){let a=[],d={},s=Helpers.getDate(e.followUp.startDate),i=Helpers.getDate(e.followUp.endDate);o.endDate.isAfter(i)&&(o.endDate=i.clone()),o.startDate.isBefore(s)&&(o.startDate=s.clone());for(let s=o.startDate.clone();s<=o.endDate;s.add(n,"day")){let o=l,n=[],i=e.followUpsList.filter(e=>Helpers.getDate(e.date).isSame(s,"d"));o-=i.length,s.isSameOrAfter(Helpers.getDateEndOfDay(),"day")&&n.push(...i.filter(e=>"LNG_REFERENCE_DATA_CONTACT_DAILY_FOLLOW_UP_STATUS_TYPE_NOT_PERFORMED"===e.statusId).map(e=>e.id)),n.forEach(o=>{d[o]=_createFollowUpEntry({outbreakId:e.outbreakId,id:o,personId:e.id,date:s.toDate(),targeted:r,teamId:RoundRobin(t),statusId:"LNG_REFERENCE_DATA_CONTACT_DAILY_FOLLOW_UP_STATUS_TYPE_NOT_PERFORMED"},e)});for(let n=0;n<o;n++){let o=_createFollowUpEntry({outbreakId:e.outbreakId,personId:e.id,date:s.toDate(),targeted:r,teamId:RoundRobin(t),statusId:"LNG_REFERENCE_DATA_CONTACT_DAILY_FOLLOW_UP_STATUS_TYPE_NOT_PERFORMED"},e);a.push(o)}}return{add:a,update:d}},module.exports.dbOperationsQueue=function(e){const t=new PromiseQueue({autoStart:!0,concurrency:10});t.count=0,t.insertBatchSize=1e5,t.deleteBatchSize=900;let o=[],n=[],l={};const r=function(o){return()=>App.models.followUp.rawBulkInsert(o,null,e).then(e=>(t.count+=e.insertedCount,Promise.resolve()))},a=function(e,t){return()=>App.models.followUp.rawBulkHardDelete({_id:{$in:e}}).then(()=>{const o=[];e.forEach(e=>{o.push(l[e]),delete l[e]}),d(o,t)})},d=function(e,n){n?t.add(r(e)):(o.push(...e),o.length>=t.insertBatchSize&&(t.add(r(o)),o=[]))},s=function(e,o){o?t.add(a(e,o)):(n.push(...e),n.length>=t.deleteBatchSize&&(t.add(a(n)),n=[]))};return{insertedCount:()=>t.count,enqueueForRecreate(e){const t=[];for(let o in e)l[o]=e[o],t.push(o);s(t)},enqueueForInsert:d,internalQueue:t,settleRemaining:()=>(n.length&&s(n,!0),o.length&&d(o,!0),t.onIdle())}};