"use strict";const momentLib=require("moment"),momentRange=require("moment-range"),moment=momentRange.extendMoment(momentLib),_=require("lodash"),apiError=require("./apiError"),xml2js=require("xml2js"),spreadSheetFile=require("./spreadSheetFile"),pdfDoc=require("./pdfDoc"),streamUtils=require("./streamUtils"),async=require("async"),fs=require("fs"),packageJson=require("../package"),workerRunner=require("./workerRunner"),crypto=require("crypto"),config=require("../server/config"),arrayFields={addresses:"address",address:"address",documents:"document",dateRanges:"dateRangeWithDetails",person:"person",labResults:"labResult",relationships:"relationship",geoLocation:"geolocation"},nonModelObjects={geolocation:{lat:"LNG_ADDRESS_FIELD_LABEL_ADDRESS_GEO_LOCATION_LAT",lng:"LNG_ADDRESS_FIELD_LABEL_ADDRESS_GEO_LOCATION_LNG"}},getDate=function(e,t){let a=e?moment.utc(e).startOf("day"):moment.utc(moment().format("YYYY-MM-DD")).startOf("day");return t?a.day(t):a},getDateEndOfDay=function(e,t){let a=e?moment.utc(e).endOf("day"):moment.utc(moment().format("YYYY-MM-DD")).endOf("day");return t?a.day(t):a},getDaysSince=function(e,t){return getDate(t).diff(getDate(e),"days")},getAsciiString=function(e){return e.replace(/[^\x00-\x7F]/g,"")},getDateChunks=function(e,t,a){e=getDate(e),t=getDateEndOfDay(t);let n=[];switch(a){case"day":let r=moment.range(e,t);n=Array.from(r.by("day")).map(e=>({start:getDate(e),end:getDateEndOfDay(e)}));break;case"week":case"month":let o=e.clone();for(;o.isBefore(t);){o.isSame(e)||o.add(1,"day");let r=o.clone().endOf("week"===a?"isoWeek":a);r.isSameOrAfter(t)&&(r=t),n.push({start:getDate(o.clone()),end:r.clone()}),o=r}}return n},getChunksForInterval=function(e,t){let a={day:"day",week:"week",month:"month"};t=t?a[t]:a.day,e[0]=getDate(e[0]),e[1]=getDateEndOfDay(e[1]);let n=getDateChunks(e[0],e[1],t),r={};return n.forEach(e=>{let t=e.start.toString()+" - "+e.end.toString();r[t]={start:e.start,end:e.end}}),r};function processMapLists(e,t){const a={prefix:t,map:{}};return Object.keys(e).forEach(function(t){const n=t.indexOf("[]"),r=e[t].indexOf("[]");if(-1!==n){if(-1!==r){const o=t.substring(0,n);a.map[o]||(a.map[o]={});const i={};t.substring(n+3).length&&(i[t.substring(n+3)]=e[t].substring(r+3)),a.map[o]=_.merge(a.map[o],processMapLists(i,e[t].substring(0,r)))}}else a.map[t]=e[t]}),a}function remapPropertiesUsingProcessedMap(e,t,a,n,r){const o=e=>{if(_.isArray(e)){const t=[];e.forEach(a=>{_.isArray(a)||_.isObject(a)?(a=o(a),_.isEmpty(a)||t.push(a)):t.push(a),e=t})}else _.isObject(e)&&_.each(e,(t,a)=>{void 0===t?delete e[a]:_.isArray(t)?e[a]=o(t):_.isObject(t)&&(t=o(t),_.isEmpty(t)?delete e[a]:e[a]=t)});return e};if(Array.isArray(e)){const i=[];return e.forEach(function(e){const s={},l=Object.keys(t.map);l.length?(l.forEach(function(r){const o=n?`${n}.`:"";if("object"==typeof t.map[r])_.set(s,t.map[r].prefix,remapPropertiesUsingProcessedMap(_.get(e,r),t.map[r],a,`${o}${r}[]`,!0));else{const n=_.get(e,r),i=(e,n)=>{let l=t.map[r];const c=t.map[r].includes("_____A");c&&(l=l.replace("_____A",""));const u=e=>{let t=_.get(s,e);return t||(t=[],_.set(s,e,t)),t};let d;void 0!==e&&"object"!=typeof e&&a&&(d=a[`${o.replace(/\[\d+]/g,"[]")}${r.replace(/\[\d+]/g,"[]")}`])&&void 0!==d[e]?n||c?u(l).push(d[e]):_.set(s,l,d[e]):_.isArray(e)?e.forEach(e=>{i(e,!0)}):n||c?void 0!==e&&u(l).push(e):_.set(s,l,e)};i(n)}}),i.push(r?s:o(s))):i.push(r?e:o(e))}),i}}const remapProperties=function(e,t,a){return remapPropertiesUsingProcessedMap(e,processMapLists(t),a)},convertPropsToDate=function(e){for(let t in e)if(e.hasOwnProperty(t))if("object"==typeof e[t]&&null!==e[t])convertPropsToDate(e[t]);else if("string"==typeof e[t]&&isValidDate(e[t])){let a=moment(e[t]);a.isValid()&&(e[t]=a.toDate())}},extractImportableFields=function(e,t){const a={};return t&&e._importableTopLevelProperties.forEach(function(e){if(void 0!==t[e])a[e]=t[e];else if(e.indexOf(".")>-1){const n=_.get(t,e);void 0!==n&&_.set(a,e,n)}}),a},getXmlFriendlyJson=function(e){let t;return Array.isArray(e)?(t=[],e.forEach(function(e){t.push(getXmlFriendlyJson(e))})):"object"==typeof e&&null!=e?(t={},Object.keys(e).forEach(function(a){let n=_.camelCase(a);"object"==typeof e[a]&&null!=e?t[n]=getXmlFriendlyJson(e[a]):t[n]=e[a]})):t=e,t},exportListFileSync=function(e,t,a,n="List"){function r(e,t={}){return e.forEach(function(e){const a=e.id.indexOf(".");if(-1!==a){let n="";n=/\[]/.test(e.id)?e.id.substring(0,a):e.id.substring(0,a+1);const o=e.id.substring(a+1);t[n]||(t[n]={}),t[n]=Object.assign({},"object"==typeof t[n]?t[n]:{},r([{id:o,header:e.header}],t[n]))}else t[e.id]=e.header}),t}function o(e,t){const a={};return Object.keys(t).forEach(function(n){if(n.endsWith("[]")&&"object"==typeof t[n]){const r=n.replace("[]","");a[t[r]]=[],e[r]?e[r].forEach(function(e){a[t[r]].push(o(e,t[n]))}):a[t[r]]=e[r]}else if(n.endsWith(".")&&"object"==typeof t[n]){const r=n.replace(".","");e[r]?a[t[r]]=o(e[r],t[n]):a[t[r]]=e[r]}else"object"==typeof t[n]?e[n]?a[n]=o(e[n],t[n]):a[n]=e[n]:n.endsWith("[]")?a[t[n]]=e[n.replace("[]","")]:void 0===a[t[n]]&&(a[t[n]]=e[n],e[n]instanceof Date&&(a[t[n]]=getDateDisplayValue(e[n])))}),a}const i={data:{},mimeType:"",extension:a};return new Promise(function(s,l){if(!Array.isArray(t))return l(new Error("Invalid dataSet. DataSet must be an array."));let c,u,d;switch(a){case"json":i.mimeType="application/json",c=r(e),u=t.map(e=>o(e,c)),i.data=JSON.stringify(u,function(e,t){return void 0===t&&(t=null),t},2),s(i);break;case"xml":i.mimeType="text/xml",d=new xml2js.Builder,c=r(e),1===(u=t.map(function(e){return{entry:o(e,c)}})).length&&(u={root:u[0]}),i.data=d.buildObject(getXmlFriendlyJson(u)),s(i);break;case"csv":i.mimeType="text/csv",spreadSheetFile.createCsvFile(e,t.map(e=>getFlatObject(e,null,!0)),function(e,t){if(e)return l(e);i.data=t,s(i)});break;case"xls":i.mimeType="application/vnd.ms-excel",spreadSheetFile.createXlsFile(e,t.map(e=>getFlatObject(e,null,!0)),function(e,t){if(e)return l(e);i.data=t,s(i)});break;case"xlsx":i.mimeType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",spreadSheetFile.createXlsxFile(e,t.map(e=>getFlatObject(e,null,!0)),function(e,t){if(e)return l(e);i.data=t,s(i)});break;case"ods":i.mimeType="application/vnd.oasis.opendocument.spreadsheet",spreadSheetFile.createOdsFile(e,t.map(e=>getFlatObject(e,null,!0)),function(e,t){if(e)return l(e);i.data=t,s(i)});break;case"pdf":i.mimeType="application/pdf",pdfDoc.createPDFList(e,t.map(e=>getFlatObject(e,null,!0)),n,function(e,t){if(e)return l(e);i.data=t,s(i)});break;default:l(apiError.getError("REQUEST_VALIDATION_ERROR",{errorMessages:`Invalid Export Type: ${a}. Supported options: json, xml, csv, xls, xlsx, ods, pdf`}))}})},exportListFile=workerRunner.helpers.exportListFile,getReferencedValue=function(e,t){let a;if(/\[]/.test(t)){a=[];const n=t.indexOf("[]"),r=t.substring(0,n),o=t.substring(n+3);let i=_.get(e,r,[]);(i=i||[]).forEach(function(e,t){if(o){let n=getReferencedValue(e,o);Array.isArray(n)||(n=[n]),n.forEach(function(e){a.push({value:e.value,exactPath:`${r}[${t}].${e.exactPath}`})})}else a.push({value:e,exactPath:`${r}[${t}]`})})}else a={value:_.get(e,t),exactPath:t};return a},resolveModelForeignKeys=function(e,t,a,n,r){return void 0===r&&(r=!0),new Promise(function(o,i){const s={};let l=!1;t.foreignKeyResolverMap&&(l=!0);let c={};if(a.forEach(function(e,a){l&&Object.keys(t.foreignKeyResolverMap).forEach(function(n){let r=getReferencedValue(e,n);Array.isArray(r)||(r=[r]),r.forEach(function(e){c[`[${a}].${e.exactPath}`]={modelName:t.foreignKeyResolverMap[n].modelName,key:n,value:e.value,useProperty:t.foreignKeyResolverMap[n].useProperty},s[t.foreignKeyResolverMap[n].modelName]||(s[t.foreignKeyResolverMap[n].modelName]=[]),s[t.foreignKeyResolverMap[n].modelName].push(e.value)})}),r&&translateDataSetReferenceDataValues(e,t,n)}),l){const t={};Object.keys(s).forEach(function(a){t[a]=function(t){e.models[a].rawFind({id:{inq:s[a]}}).then(function(e){t(null,e)}).catch(t)}}),async.parallelLimit(t,10,function(e,t){if(e)return i(e);let n={};Object.keys(t).forEach(function(e){n[e]={},t[e].forEach(function(t){n[e][t.id]=t})}),Object.keys(c).forEach(function(e){if(Array.isArray(c[e].useProperty)){let t=e.replace(c[e].key,c[e].modelName);c[e].useProperty.forEach(function(r){_.set(a,`${t}.${r}`,_.get(n,`${c[e].modelName}.${c[e].value}.${r}`))})}else _.set(a,e,_.get(n,`${c[e].modelName}.${c[e].value}.${c[e].useProperty}`))}),o(a)})}else o(a)})},getFlatObject=function(e,t,a){let n,r={};return null==t&&(t=""),null==a&&(a=!1),Array.isArray(e)?e.forEach(function(e,o){n=`${t}[${o}]`,a&&(n=`${t} ${o+1}`.trim()),e&&"object"==typeof e?r=Object.assign({},r,getFlatObject(e,n,a)):r[n]=e}):"object"==typeof e&&Object.keys(e).forEach(function(o){n=t,n=a?`${n} ${o}`.trim():n.length?`${n}.${o}`:o,e[o]&&"object"==typeof e[o]?e[o]instanceof Date?r[n]=getDateDisplayValue(e[o]):r=Object.assign({},r,getFlatObject(e[o],n,a)):r[n]=e[o]}),r},getDateDisplayValue=function(e){return e&&moment(e).isValid()?new Date(e).toISOString():e},parseModelFieldValues=function(e,t){t.fieldsToParse&&t.fieldToValueParsersMap&&t.fieldsToParse.forEach(function(a){let n=getReferencedValue(e,a);Array.isArray(n)?n.forEach(n=>_.set(e,n.exactPath,t.fieldToValueParsersMap[a](n.value))):n.value&&_.set(e,n.exactPath,t.fieldToValueParsersMap[a](n.value))})},isPathOK=function(e){fs.accessSync(e,fs.constants.R_OK|fs.constants.W_OK)},formatDate=function(e){let t="";if(e){let a=moment(getDateDisplayValue(e));a.isValid()&&(t=a.format("YYYY-MM-DD"))}return t},formatDateFields=function(e,t){t.forEach(t=>{let a=getReferencedValue(e,t);Array.isArray(a)?a.forEach(t=>{_.set(e,t.exactPath,formatDate(t.value))}):_.set(e,a.exactPath,formatDate(a.value))})},formatUndefinedValues=function(e){Object.keys(e).forEach(t=>{Array.isArray(e[t])?e[t].forEach(e=>{formatUndefinedValues(e)}):"object"==typeof e[t]&&null!==e[t]?formatUndefinedValues(e[t]):void 0===e[t]&&_.set(e,t,"")})},translateDataSetReferenceDataValues=function(e,t,a){t.referenceDataFields&&(Array.isArray(e)||(e=[e]),e.forEach(e=>{t.referenceDataFields.forEach(t=>{let n=getReferencedValue(e,t);Array.isArray(n)?n.forEach(t=>{_.set(e,t.exactPath,t.value?a.getTranslation(t.value):"")}):_.set(e,n.exactPath,n.value?a.getTranslation(n.value):"")})}))},translateFieldLabels=function(e,t,a,n,r){r=r||!1;let o={},i={},s={};if(e.models[a]){i=e.models[a].locationsFieldsMap||{},Object.keys(i).forEach(e=>{o[`${e}_parentLocations`]=i[e]}),s=Object.assign(e.models[a].fieldLabelsMap,e.models[a].relatedFieldLabelsMap);let n=e.models[a].printFieldsinOrder;r&&(n=[].concat(n,Object.keys(o))),t=_.pick(t,n)}else s=nonModelObjects[a];let l={};return Object.keys(t).forEach(function(c){let u=t[c],d=u;if(s&&s[c]){if(Array.isArray(u)&&u.length&&"object"==typeof u[0]&&arrayFields[c]?(d=[],u.forEach((t,a)=>{d[a]=translateFieldLabels(e,t,arrayFields[c],n,r)})):"object"==typeof u&&null!==u&&Object.keys(u).length>0&&(d=translateFieldLabels(e,u,arrayFields[c],n,r)),l[n.getTranslation(e.models[a]?s[c]:nonModelObjects[a][c])]=d,r&&i[c]){const e=`${c}_parentLocations`;(t[e]||[]).forEach((t,a)=>{const r=n.getTranslation(o[e]),i=n.getTranslation("LNG_OUTBREAK_FIELD_LABEL_LOCATION_GEOGRAPHICAL_LEVEL");l[`${r} ${i} ${a}`]=t}),delete t[e]}}else o[c]&&r||(l[c]=u)}),l},includeSubLocationsInLocationFilter=function(e,t,a){const n=[];Object.keys(t).forEach(function(a){if(a.includes("parentLocationIdFilter")){let r,o="inq";"string"==typeof t[a]?r=[t[a]]:t[a]&&"object"==typeof t[a]&&Array.isArray(t[a].inq)?r=t[a].inq:t[a]&&"object"==typeof t[a]&&Array.isArray(t[a].$in)&&(r=t[a].$in,o="$in"),r&&n.push(function(n){e.models.location.getSubLocations(r,[],function(e,r){if(e)return n(e);t[a.replace("parentLocationIdFilter","locationId")]={[o]:r},delete t[a],n()})})}else Array.isArray(t[a])?t[a].forEach(function(t){t&&"object"==typeof t&&n.push(function(a){includeSubLocationsInLocationFilter(e,t,a)})}):t[a]&&"object"==typeof t[a]&&n.push(function(n){includeSubLocationsInLocationFilter(e,t[a],n)})}),async.series(n,a)},getBuildInformation=function(){return{platform:_.get(packageJson,"build.platform","-"),version:_.get(packageJson,"build.version",_.get(packageJson,"version")),build:_.get(packageJson,"build.build","development"),arch:_.get(packageJson,"build.arch","x64")}},isValidDate=function(e){return/^\d{4}-\d{2}-\d{2}[\sT]?(?:\d{2}:\d{2}:\d{2}(\.\d{3})?Z*)?$/.test(e)},convertBooleanProperties=function(e,t){function a(t){e._booleanProperties.forEach(function(e){null!=t[e]&&"boolean"!=typeof t[e]&&(t[e]=["1","true"].includes(t[e].toString().toLowerCase()))})}return e._booleanProperties||(e._booleanProperties=[],e.forEachProperty(function(t){e.definition.properties[t].type&&"Boolean"===e.definition.properties[t].type.name&&e._booleanProperties.push(t)})),Array.isArray(t)?t.forEach(function(e){a(e)}):a(t),t},getSourceAndTargetFromModelHookContext=function(e){const t={};return e.instance?("function"==typeof e.instance.toJSON?t.source={existing:e.instance.toJSON(),existingRaw:e.instance,updated:{}}:t.source={existing:e.instance,existingRaw:e.instance,updated:{}},t.target=e.instance):(e.currentInstance&&"function"==typeof e.currentInstance.toJSON?t.source={existing:e.currentInstance.toJSON(),existingRaw:e.currentInstance,updated:e.data}:t.source={existing:e.currentInstance,existingRaw:e.currentInstance,updated:e.data},t.target=e.data),t.source.all=Object.assign({},t.source.existing,t.source.updated),t},retrieveQuestionnaireVariables=(e,t,a,n,r,o,i)=>{if(_.isEmpty(e))return[];const s=[];return _.each(e,e=>{if("LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_MARKUP"!==e.answerType){if(!_.isEmpty(e.variable)){const l=e.multiAnswer||o;if(r[e.variable]=r[e.variable]||0,"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_MULTIPLE_ANSWERS"===e.answerType){if(!_.isEmpty(e.answers))if(l){const o=o=>{_.each(e.answers,(i,c)=>{s.push({id:`${t||""} ${e.variable} ${o} date`,header:`${n?e.variable:a.getTranslation(e.text)} [MD ${o}]`}),s.push({expandKey:e.variable,expandHeader:n?e.variable:a.getTranslation(e.text),id:`${t||""} ${e.variable} ${o} value ${c+1}`,header:`${n?e.variable:a.getTranslation(e.text)} ${c+1} [MV ${o}]`}),_.isEmpty(i.additionalQuestions)||s.push(...retrieveQuestionnaireVariables(i.additionalQuestions,t,a,n,r,l,o))})};if(i)o(i);else for(let t=0;t<r[e.variable];t++)o(t+1)}else _.each(e.answers,(o,c)=>{s.push({expandKey:e.variable,expandHeader:n?e.variable:a.getTranslation(e.text),id:`${t||""} ${e.variable} 1 value ${c+1}`,header:`${n?e.variable:a.getTranslation(e.text)} ${c+1}`}),_.isEmpty(o.additionalQuestions)||s.push(...retrieveQuestionnaireVariables(o.additionalQuestions,t,a,n,r,l,i))})}else if(l){const o=o=>{s.push({id:`${t||""} ${e.variable} ${o} date`,header:`${n?e.variable:a.getTranslation(e.text)} [MD ${o}]`},{expandKey:e.variable,expandHeader:n?e.variable:a.getTranslation(e.text),id:`${t||""} ${e.variable} ${o} value`,header:`${n?e.variable:a.getTranslation(e.text)} [MV ${o}]`}),_.isEmpty(e.answers)||_.each(e.answers,e=>{_.isEmpty(e.additionalQuestions)||s.push(...retrieveQuestionnaireVariables(e.additionalQuestions,t,a,n,r,l,o))})};if(i)o(i);else for(let t=0;t<r[e.variable];t++)o(t+1)}else s.push({expandKey:e.variable,expandHeader:n?e.variable:a.getTranslation(e.text),id:(t?t+" ":"")+e.variable+" 1 value",header:n?e.variable:a.getTranslation(e.text)}),_.isEmpty(e.answers)||_.each(e.answers,e=>{_.isEmpty(e.additionalQuestions)||s.push(...retrieveQuestionnaireVariables(e.additionalQuestions,t,a,n,r,l,i))})}}else s.push({expandKey:e.variable,expandHeader:n?e.variable:a.getTranslation(e.text),id:(t?t+" ":"")+e.variable,header:n?e.variable:a.getTranslation(e.text)})}),s},translateQuestionAnswers=function(e,t,a){let n={};if(Array.isArray(t)){let r=[];return t.forEach(t=>{(n=_.find(e.answers,["value",t]))&&n.label?r.push(a.getTranslation(n.label)):r.push(buildAndTranslateAnswerLabel(e.text,t,a))}),r}return(n=_.find(e.answers,["value",t]))&&n.label?a.getTranslation(n.label):buildAndTranslateAnswerLabel(e.text,t,a)},buildAndTranslateAnswerLabel=function(e,t,a){let n=t;if(/_TEXT$/.test(e)){let r=e.replace(/_TEXT$/,`_ANSWER_${_.upperCase(t)}_LABEL`),o=a.getTranslation(r);r!==o&&(n=o)}return n},setValueInContextOptions=function(e,t,a,n="_data"){_.set(e,`options.${e.Model.modelName}._instance[${e.instance?e.instance.id:e.currentInstance.id}][${n}][${t}]`,a)},getValueFromContextOptions=function(e,t,a="_data"){return _.get(e,`options.${e.Model.modelName}._instance[${e.instance?e.instance.id:e.currentInstance.id}][${a}][${t}]`,null)},setOriginalValueInContextOptions=function(e,t,a){setValueInContextOptions(e,t,a,"_original")},getOriginalValueFromContextOptions=function(e,t){return getValueFromContextOptions(e,t,"_original")},paginateResultSet=function(e,t){const a=_.get(e,"skip",0);let n=_.get(e,"limit");return null!=n&&(n=a+n),(a||n)&&(t=t.slice(a,n)),t},getPeriodIntervalForDate=function(e,t,a){let n,r;switch(t){case"day":n=getDate(a),r=getDateEndOfDay(a);break;case"week":n=getDate(a).startOf("isoWeek"),r=getDateEndOfDay(a).endOf("isoWeek");break;case"month":n=getDate(a).startOf("month"),r=getDateEndOfDay(a).endOf("month")}return e&&e.length>1&&(n=n.isAfter(e[0])?n:getDate(e[0]),r=(r=r.isBefore(e[1])?r:getDateEndOfDay(e[1])).isAfter(n)?r:getDateEndOfDay(n)),[n.toString(),r.toString()]},createImageDoc=workerRunner.helpers.createImageDoc;function sha256(e){return crypto.createHash("sha256").update(e).digest("hex")}function convertToDate(e){return moment(e).startOf("day")}function migrateModelDataInBatches(e,t){return new Promise((a,n)=>{e.count({$or:[{deleted:!1},{deleted:{$eq:null}},{deleted:!0}]}).then(r=>{let o=0;const i=()=>{e.find({deleted:!0,skip:o,limit:1e3}).then(e=>{const s=[];e.forEach(e=>{s.push(a=>{t(e,a)})}),async.parallelLimit(s,10,e=>{e&&n(e),(o+=1e3)<r?i():a()})}).catch(n)};o<r?i():a()}).catch(n)})}function covertAddressesGeoPointToLoopbackFormat(e={}){if(!e.address&&!e.addresses&&!e.fillLocation)return;let t;t=e.address?[e.address]:e.addresses,_.isEmpty(e.fillLocation)||(t=[...t,e.fillLocation]),t.forEach(function(e){e.geoLocation&&"object"==typeof e.geoLocation&&e.geoLocation.coordinates&&void 0===e.geoLocation.lng&&void 0===e.geoLocation.lat&&_.set(e,"geoLocation",{lat:e.geoLocation.coordinates[1],lng:e.geoLocation.coordinates[0]})})}const sortMultiAnswerQuestions=function(e){if(e&&_.isObject(e.questionnaireAnswers)){const t=e.questionnaireAnswers;for(let e in t)Array.isArray(t[e])&&t[e].length&&(t[e]=t[e].sort((e,t)=>moment(t.date).format("X")-moment(e.date).format("X")))}},convertQuestionStringDatesToDates=function(e,t){return new Promise(function(a){if(e.questionnaireAnswers&&(convertPropsToDate(e.questionnaireAnswers),!_.isEmpty(t))){const a={},n=e=>{(e||[]).forEach(e=>{a[e.variable]=e.answerType,_.isEmpty(e.answers)||(e.answers||[]).forEach(e=>{_.isEmpty(e.additionalQuestions)||n(e.additionalQuestions)})})};n(t),_.each(e.questionnaireAnswers,(e,t)=>{a[t]&&"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_NUMERIC"===a[t]&&(e||[]).forEach(e=>{if(void 0!==e.value&&null!==e.value&&"number"!=typeof e.value)try{e.value=parseFloat(e.value)}catch(t){e.value=null}})})}a()})},convertQuestionAnswerToOldFormat=function(e){return Array.isArray(e)&&e.length>0&&"object"==typeof e[0]?e.slice(0,1)[0].value:e},convertQuestionnaireAnswersToOldFormat=function(e){const t={};for(let a in e)t[a]=convertQuestionAnswerToOldFormat(e[a]);return t},convertQuestionnaireAnswersToNewFormat=function(e){const t={};for(let a in e)!e[a]||!_.isArray(e[a])||e[a].length>0&&!_.isObject(e[a][0])?t[a]=[{value:e[a]}]:t[a]=e[a];return t},getQuestionnaireMaxAnswersMap=function(e,t,a){a=a||{questionToTranslationMap:[]},e=(e||[]).filter(e=>e.multiAnswer);let n={};!function e(t){(t||[]).forEach(t=>{n[t.variable]=[],(t.answers||[]).forEach(t=>e(t.additionalQuestions))})}(e),t.forEach(e=>{let t="questionnaireAnswers";if(!e[t]){if(!e[a.containerPropTranslation])return;t=a.containerPropTranslation}for(let r in e[t])if(e[t].hasOwnProperty(r))if(n[r])n[r].push(e[t][r].length);else{const o=a.questionToTranslationMap.find(e=>e.translation===r);o&&n[o.variable].push(e[t][r].length)}});for(let e in n)if(n.hasOwnProperty(e)){let t=0;n[e].length&&(t=Math.max(...n[e])),n[e]=t}return n},convertQuestionnairePropsToDate=function(e){const t=function(e){if(null===e||"undefined"===e)return e;if(isValidDate(e)){let t=getDate(e);if(t.isValid())return t.toDate()}return e};for(let a in e)e[a]=e[a].map(e=>{if(e.date&&(e.date=t(e.date)),Array.isArray(e.value)){const a=[];e.value.forEach(e=>{if(null==e)return!1;a.push(t(e))}),e.value=a}else e.value=t(e.value);return e});return e},getFilterCustomOption=function(e,t){(e=e||{}).where=e.where||{};const a=e.where[t];return delete e.where[t],a},attachParentLocations=function(e,t,a,n){const r=[],o={};for(let t of a){o[t.id]=[];for(let a of e.locationFields||[]){let e=getReferencedValue(t,a);Array.isArray(e)||(e=[e]),o[t.id].push(...e.filter(e=>e.value));for(let t of e)t.value&&r.push(t.value)}}return r.length?t.getParentLocationsWithDetails(r,[],{},(e,t)=>{if(e)return n(e);const r={};for(let e of t)r[e.id]={name:e.name,parentLocationId:e.parentLocationId,geographicalLevelId:e.geographicalLevelId};let i=0;for(let e of a){const t=o[e.id];for(let a of t){const t=[];!function e(a){const n=r[a];if(n){if(!n.parentLocationId)return null;t.unshift(r[n.parentLocationId].name),e(n.parentLocationId)}}(a.value),_.set(e,`${a.exactPath}_parentLocations`,t),t.length>i&&(i=t.length)}}return n(null,{records:a,highestParentsChain:i})}):n(null,{records:a})},removeFilterOptions=function(e,t){(e=e||{}).where=e.where||{};for(let a of t)delete e.where[a];return e},attachCustomDeleteFilterOption=function(e){return(e=e||{}).where=e.where||{},e.deleted&&(e.where.includeDeletedRecords=!0),e},getMaximumLengthForArrays=function(e,t){const a={};t.forEach(e=>{a[e]=[]}),e.forEach(e=>{t.forEach(t=>{Array.isArray(e[t])&&a[t].push(e[t].length)})});for(let e in a)if(a.hasOwnProperty(e)){let t=0;a[e].length&&(t=Math.max(...a[e])),a[e]=t}return a},getCaptchaConfig=()=>{const e=config.captcha||{};return void 0===e.login&&(e.login=!0),void 0===e.forgotPassword&&(e.forgotPassword=!0),void 0===e.resetPasswordQuestions&&(e.resetPasswordQuestions=!0),e},handleActionsInBatches=function(e,t,a,n,r,o,i){return e().then(e=>{if(0===e)return i.debug("No data found for which to execute actions"),Promise.resolve();let s=Math.ceil(e/r);i.debug(`Actions to be done: ${e}. Batches: ${s}`);const l=(c=1)=>(i.debug(`Processing batch ${c} of ${s}`),t(c,r).then(e=>a?a(e).then(()=>e):e).then(e=>{if(!n)return;let t=e.map(e=>t=>n(e).then(()=>t()).catch(t));return new Promise((e,a)=>{async.parallelLimit(t,o,t=>t?a(t):e())})}).then(()=>(i.debug(`Finished processing batch ${c} of ${s}`),c*r>e?(i.debug("All data has been processed"),Promise.resolve()):l(++c))));return i.debug("Processing actions in batches"),l()})};module.exports={getDate:getDate,streamToBuffer:streamUtils.streamToBuffer,remapProperties:remapProperties,getDateEndOfDay:getDateEndOfDay,getAsciiString:getAsciiString,getChunksForInterval:getChunksForInterval,convertPropsToDate:convertPropsToDate,isValidDate:isValidDate,extractImportableFields:extractImportableFields,exportListFile:exportListFile,exportListFileSync:exportListFileSync,getReferencedValue:getReferencedValue,resolveModelForeignKeys:resolveModelForeignKeys,getFlatObject:getFlatObject,getDateDisplayValue:getDateDisplayValue,parseModelFieldValues:parseModelFieldValues,isPathOK:isPathOK,formatDateFields:formatDateFields,formatUndefinedValues:formatUndefinedValues,translateDataSetReferenceDataValues:translateDataSetReferenceDataValues,translateFieldLabels:translateFieldLabels,includeSubLocationsInLocationFilter:includeSubLocationsInLocationFilter,translateQuestionAnswers:translateQuestionAnswers,getBuildInformation:getBuildInformation,convertBooleanProperties:convertBooleanProperties,getSourceAndTargetFromModelHookContext:getSourceAndTargetFromModelHookContext,setOriginalValueInContextOptions:setOriginalValueInContextOptions,getOriginalValueFromContextOptions:getOriginalValueFromContextOptions,paginateResultSet:paginateResultSet,setValueInContextOptions:setValueInContextOptions,getValueFromContextOptions:getValueFromContextOptions,getPeriodIntervalForDate:getPeriodIntervalForDate,sha256:sha256,createImageDoc:createImageDoc,convertToDate:convertToDate,migrateModelDataInBatches:migrateModelDataInBatches,covertAddressesGeoPointToLoopbackFormat:covertAddressesGeoPointToLoopbackFormat,sortMultiAnswerQuestions:sortMultiAnswerQuestions,convertQuestionStringDatesToDates:convertQuestionStringDatesToDates,convertQuestionAnswerToOldFormat:convertQuestionAnswerToOldFormat,convertQuestionnaireAnswersToOldFormat:convertQuestionnaireAnswersToOldFormat,convertQuestionnaireAnswersToNewFormat:convertQuestionnaireAnswersToNewFormat,retrieveQuestionnaireVariables:retrieveQuestionnaireVariables,getDateChunks:getDateChunks,getDaysSince:getDaysSince,getQuestionnaireMaxAnswersMap:getQuestionnaireMaxAnswersMap,convertQuestionnairePropsToDate:convertQuestionnairePropsToDate,getFilterCustomOption:getFilterCustomOption,attachParentLocations:attachParentLocations,removeFilterOptions:removeFilterOptions,attachCustomDeleteFilterOption:attachCustomDeleteFilterOption,getMaximumLengthForArrays:getMaximumLengthForArrays,getCaptchaConfig:getCaptchaConfig,handleActionsInBatches:handleActionsInBatches};