"use strict";const app=require("../../server/server"),async=require("async"),_=require("lodash");module.exports=function(t){t.prototype.updateLanguageTranslations=function(t,e,n){const o=this,a=[],i=[];return new Promise(function(r,u){t.forEach(function(t){a.push(function(a){app.models.languageToken.findOne({where:{token:t.token,languageId:o.id}}).then(function(a){const i=(n,i)=>a?a.updateAttributes({translation:t.translation,outbreakId:n,modules:i},e):app.models.languageToken.create({token:t.token,languageId:o.id,translation:t.translation,outbreakId:n,modules:i,createdAt:t.createdAt,updatedAt:t.updatedAt},e);let r=t.outbreakId;!r&&a&&(r=a.outbreakId);let u=t.modules;return _.isEmpty(u)&&a&&(u=a.modules),n&&_.isEmpty(u)?app.models.languageToken.find({where:{token:t.token,modules:{exists:!0}}}).then(function(t){let e,n;if(!_.isEmpty(t)){let o;for(o of t)if(e=e||o.outbreakId,_.isEmpty(o.modules)||(n=n||o.modules),e&&!_.isEmpty(o.modules))break}return i(e,n)}):i(r,u)}).then(function(t){a(null,t)}).catch(function(e){i.push({token:t,error:e}),a()})})}),async.parallelLimit(a,10,function(t,e){return t?u({errors:[t],success:e||[]}):i.length?u({errors:i,success:e||[]}):void r(e)})})},t.prototype.isEditable=function(t){t(null,!this.readOnly)},t.isEditable=function(e,n){t.findById(e).then(function(t){t.isEditable(n)}).catch(n)},t.checkIfEditable=function(e,n){let o=e,a=t.isEditable.bind(null,o);"object"==typeof e&&(o=e.id,a=e.isEditable.bind(e)),a(function(e,a){return e?n(e):a?void n():n(app.utils.apiError.getError("MODEL_NOT_EDITABLE",{model:t.modelName,id:o}))})},t.getLanguageDictionary=function(t,e){app.models.languageToken.rawFind({or:[{languageId:t},{languageId:"english_us"}]},{projection:{token:1,translation:1,languageId:1}}).then(function(n){const o={};n.forEach(function(t){o[`${t.token}-${t.languageId}`]=t.translation}),o.getTranslation=function(e){return this[`${e}-${t}`]?e=this[`${e}-${t}`]:this[`${e}-english_us`]&&(e=this[`${e}-english_us`]),e},e(null,o)}).catch(e)},t.getFieldTranslationFromDictionary=function(t,e,n){return n.getTranslation(t)}};