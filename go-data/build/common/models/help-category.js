"use strict";const app=require("../../server/server"),_=require("lodash"),helpers=require("../../components/helpers"),uuid=require("uuid").v4;module.exports=function(e){e.hasController=!0,e.defaultOrder=["order ASC"],e.observe("before save",function(n,t){if(n.options&&n.options._sync)return t();if(n.isNewInstance){let t=n.instance,i=`LNG_${_.snakeCase(e.modelName).toUpperCase()}_${_.snakeCase(t.name).toUpperCase()}`;i=`${i}_${uuid()}`,t.id=i,helpers.setOriginalValueInContextOptions(n,"name",t.name),helpers.setOriginalValueInContextOptions(n,"description",t.description),t.name=i,t.description=i+"_DESCRIPTION"}else if(n.data&&(n.data.name||n.data.description)){let e={},t=n.data;t.name&&(e.name=t.name,delete t.name),t.description&&(e.description=t.description,delete t.description),helpers.setOriginalValueInContextOptions(n,"name",e.name),helpers.setOriginalValueInContextOptions(n,"description",e.description)}t()}),e.observe("after save",function(e,n){if(e.options&&e.options._sync)return n();const t=app.models,i=t.languageToken;let a=helpers.getOriginalValueFromContextOptions(e,"name"),s=helpers.getOriginalValueFromContextOptions(e,"description")||"";if(e.isNewInstance)if(a){let o=[];t.language.find().then(function(n){return n.forEach(n=>{o.push(i.create({token:e.instance.name,languageId:n.id,translation:a},e.options),i.create({token:e.instance.description,languageId:n.id,translation:s},e.options))})}).then(()=>Promise.all(o)).then(()=>n()).catch(e=>n(e))}else n();else if(a||s){let t=e.options.remotingContext.req.authData.user.languageId,o=e.instance.id,r=[],l=[];a&&l.push("name"),s&&l.push("description"),l.forEach(n=>{r.push(i.findOne({where:{token:"description"===n?o+"_DESCRIPTION":o,languageId:t}}).then(t=>t.updateAttribute("translation",helpers.getOriginalValueFromContextOptions(e,n),e.options)))}),Promise.all(r).then(()=>n()).catch(n)}else n()})};