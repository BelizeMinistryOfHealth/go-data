"use strict";const app=require("../../server/server"),_=require("lodash"),helpers=require("../../components/helpers"),uuid=require("uuid").v4;module.exports=function(e){e.defaultOrder=["order ASC"],e.observe("before save",function(t,n){if(t.options&&t.options._sync)return n();if(t.isNewInstance){let n=t.instance,o=`${t.instance.categoryId}_${_.snakeCase(e.modelName).toUpperCase()}_${_.snakeCase(n.title).toUpperCase()}`;o=`${o}_${uuid()}`,n.id=o,helpers.setOriginalValueInContextOptions(t,"title",n.title),helpers.setOriginalValueInContextOptions(t,"content",n.content),n.title=o,n.content=o+"_DESCRIPTION"}else if(t.data&&(t.data.title||t.data.content)){let e={},n=t.data;n.title&&(e.title=n.title,delete n.title),n.content&&(e.content=n.content,delete n.content),helpers.setOriginalValueInContextOptions(t,"title",e.title),helpers.setOriginalValueInContextOptions(t,"content",e.content)}n()}),e.observe("after save",function(e,t){if(e.options&&e.options._sync)return t();const n=app.models,o=n.languageToken;let i=helpers.getOriginalValueFromContextOptions(e,"title"),r=helpers.getOriginalValueFromContextOptions(e,"content");if(e.isNewInstance)if(i){let a=[];n.language.find().then(function(t){return t.forEach(t=>{a.push(o.create({token:e.instance.title,languageId:t.id,translation:i},e.options),o.create({token:e.instance.content,languageId:t.id,translation:r},e.options))})}).then(()=>Promise.all(a)).then(()=>t()).catch(e=>t(e))}else t();else if(i||r){let n=e.options.remotingContext.req.authData.user.languageId,a=e.instance.id,s=[],l=[];i&&l.push("title"),r&&l.push("content"),l.forEach(t=>{s.push(o.findOne({where:{token:"content"===t?a+"_DESCRIPTION":a,languageId:n}}).then(n=>n.updateAttribute("translation",helpers.getOriginalValueFromContextOptions(e,t),e.options)))}),Promise.all(s).then(()=>t()).catch(t)}else t()}),e.findAggregate=((e,t)=>new Promise((n,o)=>{let i=(e=e||{}).where?app.utils.remote.convertLoopbackFilterToMongo(e.where):{};const r={$or:[{deleted:!1},{deleted:{$eq:null}}]},a=[{$match:i=_.isEmpty(i)?r:{$and:[i,r]}}];if(t)a.push({$project:{_id:1}});else{a.push(...[{$lookup:{from:"helpCategory",localField:"categoryId",foreignField:"_id",as:"category"}},{$unwind:{path:"$category",preserveNullAndEmptyArrays:!0}}]);const t={ASC:1,DESC:-1},n={};Array.isArray(e.order)&&e.order.forEach(e=>{const o=e.split(" ");2===o.length&&(o[1]=o[1].toUpperCase(),t.hasOwnProperty(o[1])&&(n[o[0]]=t[o[1]]))}),Object.keys(n).length&&a.push({$sort:n}),isNaN(e.skip)||a.push({$skip:e.skip}),isNaN(e.limit)||a.push({$limit:e.limit})}app.dataSources.mongoDb.connector.collection("helpItem").aggregate(a).toArray().then(e=>{if(e=e||[],t)return n(e.length);e.forEach(e=>{e.id=e._id,delete e._id,e.category&&(e.category.id=e.category._id,delete e.category._id)}),n(e)}).catch(o)}))};