"use strict";const app=require("../../server/server"),path=require("path"),fs=require("fs"),xml2js=require("xml2js"),xlsx=require("xlsx"),os=require("os"),uuid=require("uuid"),sort=require("alphanum-sort");module.exports=function(e){function r({data:e},r){try{const t=JSON.parse(e);if(!Array.isArray(t))return r(app.utils.apiError.getError("INVALID_CONTENT_OF_TYPE",{contentType:"JSON",details:"it should contain an array"}));const s=[];t.forEach(function(e){Object.keys(app.utils.helpers.getFlatObject(e)).forEach(function(e){const r=e.replace(/\[\d+]$/g,"").replace(/\[\d+]/g,"[]").replace(/^\[]\.*/,"");s.includes(r)||s.push(r)})}),r(null,{obj:t,headers:s})}catch(e){r(app.utils.apiError.getError("INVALID_CONTENT_OF_TYPE",{contentType:"JSON",details:e.message}))}}function t({data:e,modelName:r,dictionary:t,questionnaire:s},n){const i={explicitArray:!0,explicitRoot:!1},a={},o=app.models[r].arrayProps||[];(o.length||s)&&(i.explicitArray=!1,s&&function e(r){return(r||[]).map(r=>{if(a[r.variable]=r.answerType,Array.isArray(r.answers)&&r.answers.length)for(let t of r.answers)e(t.additionalQuestions)})}(s.toJSON())),xml2js.parseString(e,i,function(e,r){if(e)return n(e);let s=r[Object.keys(r).shift()];"object"!=typeof s||Array.isArray(s)||(s=[s]);const i=[];s=s.map(e=>{for(let r in e)(o[r]||o[t.getTranslation(r)])&&(Array.isArray(e[r])||"object"!=typeof e[r]||(e[r]=[e[r]]));if(e.questionnaireAnswers&&Object.keys(a).length)for(let r in e.questionnaireAnswers)if(e.questionnaireAnswers.hasOwnProperty(r)){const t=a[r];Array.isArray(e.questionnaireAnswers[r])||(e.questionnaireAnswers[r]=[e.questionnaireAnswers[r]]),"LNG_REFERENCE_DATA_CATEGORY_QUESTION_ANSWER_TYPE_MULTIPLE_ANSWERS"===t&&(e.questionnaireAnswers[r]=e.questionnaireAnswers[r].map(e=>(Array.isArray(e.value)||(e.value=[e.value]),e)))}return Object.keys(app.utils.helpers.getFlatObject(e)).forEach(function(e){const r=e.replace(/\[\d+]$/g,"").replace(/\[\d+]/g,"[]").replace(/^\[]\.*/,"");i.includes(r)||i.push(r)}),e}),n(null,{obj:s,headers:i})})}function s({data:e,extension:r},t){const s={cellText:!1};".csv"===r?s.raw=!0:s.cellDates=!0;const n=xlsx.read(e,s);let i=n.SheetNames.shift(),a=xlsx.utils.sheet_to_json(n.Sheets[i]);const o=sort(Object.keys(n.Sheets[i]).filter(function(e){if("!ref"===e)return!1;const r=e.match(/(\d+)/);return!(!r||!r[1])&&1===parseInt(r[1])}));let l=[],u={};o.length&&o.forEach(function(e){let r=n.Sheets[i][`${e}`].v;void 0===u[r]?u[r]=0:(u[r]++,r=`${r}_${u[r]}`),l.push(r)}),t(null,{obj:a,headers:l})}e.hasController=!0,e.supportedFileExtensions=[".json",".xml",".csv",".xls",".xlsx",".ods"],e.temporaryStoreFileOnDisk=function(e,r){const t=uuid.v4();fs.writeFile(path.join(os.tmpdir(),t),e,function(e){r(e,t)})},e.getTemporaryFileById=function(e,r){fs.readFile(path.join(os.tmpdir(),e),r)},e.storeFileAndGetHeaders=function(n,i,a,o,l,u){const c=path.extname(n.name).toLowerCase();if(!function(r){return-1!==e.supportedFileExtensions.indexOf(r)}(c))return u(app.utils.apiError.getError("UNSUPPORTED_FILE_TYPE",{fileName:n.name,details:`unsupported extension ${c}. Supported file extensions: ${e.supportedFileExtensions.join(", ")}`}));let p;switch(c){case".json":p=r;break;case".xml":p=t;break;case".csv":case".xls":case".xlsx":case".ods":p=s}fs.readFile(n.path,function(r,t){if(r)return u(r);let s;(s=i?app.utils.aesCrypto.decrypt(i,t):Promise.resolve(t)).then(function(r){p({data:r,modelName:a,dictionary:o,questionnaire:l,extension:c},function(r,t){if(r)return u(r);e.temporaryStoreFileOnDisk(JSON.stringify(t.obj),function(e,r){u(e,{id:r,headers:t.headers,jsonObj:t.obj})})})}).catch(u)})}};