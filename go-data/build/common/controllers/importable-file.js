"use strict";const app=require("../../server/server"),templateParser=require("./../../components/templateParser"),helpers=require("./../../components/helpers"),_=require("lodash"),async=require("async"),path=require("path");function stripSpecialCharsToLowerCase(e){return _.camelCase(e).toLowerCase()}function getModelNamesFor(e){const t=[];return e&&t.push(e),e===app.models.contact.modelName&&t.push("relationship"),t}function getMappingSuggestionsForModelExtendedForm(e,t,r,o,a,n,s,l){t=t?t.toLowerCase():".json";const i={suggestedFieldMapping:{},modelProperties:{[app.models[r].extendedForm.containerProperty]:{}},modelPropertyValues:{},modelArrayProperties:{}};return app.models.outbreak.findById(e).then(function(p){if(!p)throw app.utils.apiError.getError("MODEL_NOT_FOUND",{model:app.models.outbreak.modelName,id:e});const d=e=>e.name,c=templateParser.extractVariablesAndAnswerOptions(p[app.models[r].extendedForm.template]);if(c.length){const e=c.map(function(e){return i.modelProperties[app.models[r].extendedForm.containerProperty][d(e)]=e.text,stripSpecialCharsToLowerCase(n.getTranslation(e.text))});a.forEach(function(t,a){let n=e.indexOf(t);-1!==n&&(i.suggestedFieldMapping[o[a]]=`${app.models[r].extendedForm.containerProperty}.${c[n].name}`)}),c.forEach(function(e){if(e.answers){i.modelPropertyValues[app.models[r].extendedForm.containerProperty]||(i.modelPropertyValues[app.models[r].extendedForm.containerProperty]={});const t=[];e.answers.forEach(function(e){t.push(Object.assign({id:e.value},e))}),i.modelPropertyValues[app.models[r].extendedForm.containerProperty][d(e)]=t}})}if([".json",".xml"].includes(t)){const e=p[app.models[r].extendedForm.template].filter(e=>e.multiAnswer),o=[];!function e(t){return t.forEach(t=>{t=t.toJSON?t.toJSON():t,o.push({variable:t.variable,translation:n.getTranslation(t.text)}),(t.answers||[]).forEach(t=>{e(t.additionalQuestions||[])})})}(e);const a=app.models[r].extendedForm.containerProperty,d=n.getTranslation(l[a]),c=helpers.getQuestionnaireMaxAnswersMap(e,".xml"===t?s.map(e=>{let t=a;if(!e[a]){if(!e[d])return e;t=d}return Array.isArray(e[t])&&e[t].length&&(e[t]=e[t][0]),e}):s,{containerPropTranslation:d,questionToTranslationMap:o});for(let e in c)i.modelArrayProperties[`${a}.${e}`]={maxItems:c[e]}}return i})}function getArrayPropertiesMaxLength(e){const t={};for(let r of e)!function e(r,o){for(let a in r)if(r.hasOwnProperty(a)){const n=`${o?o+".":""}${a}`;if(Array.isArray(r[a])){t[n]=t[n]||[],t[n].push(r[a].length);for(let t of r[a])"object"!=typeof t||null===t||Array.isArray(r[a])||e(t,`${n}[]`)}"object"!=typeof r[a]||null===r[a]||Array.isArray(r[a])||e(r[a],n)}}(r);for(let e in t)if(t.hasOwnProperty(e)){let r=0;t[e].length&&(r=Math.max(...t[e])),t[e]={maxItems:r}}return t}function getDistinctPropertyValues(e){const t=app.utils.helpers.getFlatObject(e);let r={};return Object.keys(t).forEach(function(e){const o=e.replace(/\[\d+]$/g,"").replace(/\[\d+]/g,"[]").replace(/^\[]\.*/,"");r[o]||(r[o]={}),r[o][t[e]]=!0}),Object.keys(r).forEach(function(e){r[e]=Object.keys(r[e])}),r}function getReferenceDataAvailableValuesForModel(e,t){const r={};return app.models.outbreak.helpers.getSystemAndOwnReferenceData(e,{where:{categoryId:{inq:Object.values(app.models[t].referenceDataFieldsToCategoryMap)},active:!0},fields:["id","categoryId","value","description"]}).then(function(e){const o={};return e.forEach(function(e){o[e.categoryId]||(o[e.categoryId]=[]),o[e.categoryId].push({id:e.id,label:e.value,value:e.value})}),Object.keys(app.models[t].referenceDataFieldsToCategoryMap).forEach(function(e){const a=e.split(".");a.length>1?(r[a[0]]||(r[a[0]]={}),r[a[0]][a[1]]||(r[a[0]][a[1]]=o[app.models[t].referenceDataFieldsToCategoryMap[e]]||[])):r[e]=o[app.models[t].referenceDataFieldsToCategoryMap[e]]||[]}),r})}function getLocationAvailableValuesForModel(e,t){return app.models.outbreak.findById(e).then(function(r){if(!r)throw app.utils.apiError.getError("MODEL_NOT_FOUND",{model:app.models.outbreak.modelName,id:e});let o;return Array.isArray(r.locationIds)&&r.locationIds.length&&(o=r.locationIds),new Promise(function(e,r){app.models.location.getSubLocationsWithDetails(o,[],{},function(o,a){if(o)return r(o);let n=[];a.forEach(function(e){n.push({id:e.id,label:e.name,value:e.id})}),n=n.sort(function(e,t){return e.label.localeCompare(t.label)});const s={};app.models[t].locationFields.forEach(function(e){const t=e.split(".");t.length>1?(s[t[0]]||(s[t[0]]={}),s[t[0]][t[1]]||(s[t[0]][t[1]]=n)):s[e]=n}),e(s)})})})}module.exports=function(e){e.upload=function(t,r,o,a,n,s,l){"function"==typeof s&&(l=s,s=void 0),app.utils.remote.helpers.parseMultipartRequest(t,[],["file"],e,[],function(t,i,p){if(r=p.file,o=i.model,a=null,"string"==typeof i.decryptPassword&&i.decryptPassword.length&&(a=i.decryptPassword),t)return l(t);const d=app.utils.remote.getUserFromOptions(n);return Promise.resolve().then(()=>s?app.models.outbreak.findById(s).then(e=>e?Promise.resolve(e):l(app.utils.apiError.getError("MODEL_NOT_FOUND",{model:app.models.outbreak.modelName,id:s}))):Promise.resolve({})).then(t=>{app.models.language.getLanguageDictionary(d.languageId,function(i,p){if(i)return l(i);const d=app.models[o].extendedForm||{};e.storeFileAndGetHeaders(r,a,o,p,t[d.template],function(e,t){if(e)return l(e);const a=path.extname(r.name),i=t.jsonObj;t={id:t.id,fileHeaders:t.headers,distinctFileColumnValues:{}};const p={};let d={},c={};const u=[],m=o;getModelNamesFor(o).forEach(function(e){if(p[e]={modelProperties:{},suggestedFieldMapping:{},modelPropertyValues:{},modelArrayProperties:{}},e&&app.models[e]&&t.fileHeaders.length){Object.keys(c).length||(c=t.fileHeaders.map(function(e){return stripSpecialCharsToLowerCase(e)})),void 0===d.getTranslation&&(app.models[e]._importableProperties&&app.models[e]._importableProperties.length||void 0!==s&&app.models[e].extendedForm&&app.models[e].extendedForm.template)&&u.push(function(e){const t=app.utils.remote.getUserFromOptions(n);app.models.language.getLanguageDictionary(t.languageId,function(t,r){if(t)return e(t);d=r,e(null,r)})});const r=app.models[e].fieldLabelsMap||{};app.models[e]._importableProperties&&app.models[e]._importableProperties.length&&u.push(function(o){const a=app.models[e]._importableProperties.map(function(t){const o=t.split(".");return o.length>1?(p[e].modelProperties[o[0]]||(p[e].modelProperties[o[0]]={}),o.length>2?(p[e].modelProperties[o[0]][o[1]]||(p[e].modelProperties[o[0]][o[1]]={}),p[e].modelProperties[o[0]][o[1]][o[2]]=r[t]):p[e].modelProperties[o[0]][o[1]]=r[t]):p[e].modelProperties[t]=r[t],stripSpecialCharsToLowerCase(d.getTranslation(r[t]))});c.forEach(function(r,o){let n=a.indexOf(r);-1!==n&&(p[e].suggestedFieldMapping[t.fileHeaders[o]]=app.models[e]._importableProperties[n])}),o(null,p[e])}),app.models[e].referenceDataFieldsToCategoryMap&&(t.distinctFileColumnValues=getDistinctPropertyValues(i),u.push(function(t){getReferenceDataAvailableValuesForModel(s,e).then(function(r){p[e]=Object.assign({},p[e],{modelPropertyValues:_.merge(p[e].modelPropertyValues,r)}),t(null,p[e])}).catch(t)})),app.models[e].locationFields&&(Object.keys(t.distinctFileColumnValues).length||(t.distinctFileColumnValues=getDistinctPropertyValues(i)),u.push(function(t){getLocationAvailableValuesForModel(s,e).then(function(r){p[e]=Object.assign({},p[e],{modelPropertyValues:_.merge(p[e].modelPropertyValues,r)}),t(null,p[e])}).catch(t)})),void 0!==s&&app.models[e].extendedForm&&app.models[e].extendedForm.template&&(Object.keys(t.distinctFileColumnValues).length||(t.distinctFileColumnValues=getDistinctPropertyValues(i)),u.push(function(o){getMappingSuggestionsForModelExtendedForm(s,a,e,t.fileHeaders,c,d,i,r).then(function(t){p[e]=Object.assign({},p[e],{suggestedFieldMapping:Object.assign(p[e].suggestedFieldMapping,t.suggestedFieldMapping)},{modelProperties:Object.assign(p[e].modelProperties,t.modelProperties)},{modelPropertyValues:Object.assign(p[e].modelPropertyValues,t.modelPropertyValues)},{modelArrayProperties:Object.assign(p[e].modelArrayProperties,t.modelArrayProperties)}),o(null,p[e])}).catch(o)})),[".json",".xml"].includes(a)&&u.push(t=>(p[e].fileArrayHeaders=getArrayPropertiesMaxLength(i),t(null,p[e]))),e===app.models.referenceData.modelName&&u.push(function(r){Object.keys(t.distinctFileColumnValues).length||(t.distinctFileColumnValues=getDistinctPropertyValues(i)),p[e]=Object.assign({},p[e],{modelPropertyValues:Object.assign(p[e].modelPropertyValues,{categoryId:app.models.referenceData.availableCategories.map(e=>Object.assign({label:e.name},e))})}),r()})}}),async.series(u,function(e){if(e)return l(e);Object.keys(p).forEach(function(e){if(e!==m){const r={};Object.keys(p[e].suggestedFieldMapping).forEach(function(t){r[t]=`${e}.${p[e].suggestedFieldMapping[t]}`}),t=Object.assign({},t,{suggestedFieldMapping:Object.assign(r,t.suggestedFieldMapping)},{modelProperties:Object.assign(t.modelProperties,{[e]:p[e].modelProperties})},{modelPropertyValues:Object.assign(t.modelPropertyValues,{[e]:p[e].modelPropertyValues})})}else t=Object.assign({},t,p[e])}),l(null,t)})})})})})},e.getJsonById=function(t,r){e.getTemporaryFileById(t,function(e,t){if(e)return r(e);try{r(null,JSON.parse(t))}catch(e){r(app.utils.apiError.getError("INVALID_CONTENT_OF_TYPE",{contentType:"JSON",details:e.message}))}})}};