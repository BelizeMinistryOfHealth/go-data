"use strict";const app=require("../../server/server"),fs=require("fs"),_=require("lodash"),async=require("async");module.exports=function(e){e.exportHierarchicalList=function(o){e.find({fields:{createdAt:!1,createdBy:!1,updatedAt:!1,updatedBy:!1,deleted:!1},order:["name ASC","parentLocationId ASC","id ASC"]}).then(function(t){app.utils.remote.helpers.offerFileToDownload(JSON.stringify(e.buildHierarchicalLocationsList(t),null,2),"application/json","locations.json",o)}).catch(o)},e.getHierarchicalList=function(o={},t){let i;void 0!==(i=_.get(o,"where.includeChildren"))?delete o.where.includeChildren:i=!0,o.fields&&(o.fields=new Array(...new Set(o.fields.concat(["id","parentLocationId"])))),e.rawFindWithLoopbackFilter(app.utils.remote.mergeFilters({order:["name ASC","parentLocationId ASC","id ASC"]},o||{})).then(function(n){if(o&&o.where&&Object.keys(o.where).length){let r=n.map(e=>e.id);e.getParentLocationsWithDetails(r,n,o,function(n,a){if(n)throw n;i?e.getSubLocationsWithDetails(r,a,o,function(o,i){if(o)throw o;t(null,e.buildHierarchicalLocationsList(i))}):t(null,e.buildHierarchicalLocationsList(a))})}else t(null,e.buildHierarchicalLocationsList(n))}).catch(t)},e.importHierarchicalList=function(o,t,i,n){app.utils.remote.helpers.parseMultipartRequest(o,[],["file"],e,[],function(o,t,r){if(o)return n(o);fs.readFile(r.file.path,function(o,t){if(o)return n(o);e.importHierarchicalListFromJsonFile(t.toString(),i,n)})})},e.importImportableFileUsingMap=function(o,t,i){app.models.importableFile.getTemporaryFileById(o.fileId,function(n,r){if(n)return i(n);try{const a=JSON.parse(r),s=app.utils.helpers.convertBooleanProperties(e,app.utils.helpers.remapProperties(a,o.map,o.valuesMap)),c=[],l=[];l.toString=function(){return JSON.stringify(this)},s.forEach(function(e,o){c.push(function(i){return app.utils.dbSync.syncRecord(t.remotingContext.req.logger,app.models.location,e,t).then(function(e){i(null,e.record)}).catch(function(t){l.push({message:`Failed to import location data ${o+1}`,error:t,recordNo:o+1,data:{file:a[o],save:e}}),i(null,null)})})}),async.parallelLimit(c,10,function(e,o){return e?i(e):l.length?((o=o.filter(e=>null!==e)).toString=function(){return JSON.stringify(this)},i(app.utils.apiError.getError("IMPORT_PARTIAL_SUCCESS",{model:app.models.location.modelName,failed:l,success:o}))):void i(null,o)})}catch(n){i(app.utils.apiError.getError("INVALID_CONTENT_OF_TYPE",{contentType:"JSON",details:n.message}))}})},e.prototype.getUsage=function(o,t){e.findModelUsage(this.id,o,!1).then(function(e){t(null,e)}).catch(t)},e.prototype.countUsage=function(o,t){e.findModelUsage(this.id,{where:o},!0).then(function(e){t(null,Object.values(e).reduce(function(e,o){return e+o}))}).catch(t)},e.prototype.propagateGeoLocationToLinkedPeople=function(o,t){const i=this;if(!this.geoLocation)return t(app.utils.apiError.getError("LOCATION_NO_GEOLOCATION_INFORMATION",{id:this.id}));app.models.person.rawFind({$or:[{addresses:{$elemMatch:{locationId:this.id,geoLocationAccurate:{$ne:!0},$or:[{"geoLocation.coordinates.0":{$ne:this.geoLocation.lng}},{"geoLocation.coordinates.1":{$ne:this.geoLocation.lat}}]}}},{"address.locationId":this.id,"address.geoLocationAccurate":{$ne:!0},$or:[{"address.geoLocation.coordinates.0":{$ne:this.geoLocation.lng}},{"address.geoLocation.coordinates.1":{$ne:this.geoLocation.lat}}]}]}).then(function(e){const t=[],n=[];return e.forEach(function(e){const r={};Array.isArray(e.addresses)&&(e.addresses.forEach(function(e){e.locationId!==i.id||e.geoLocationAccurate||(e.geoLocation={coordinates:[i.geoLocation.lng,i.geoLocation.lat],type:"Point"})}),r.addresses=e.addresses),e.address&&e.address.locationId===i.id&&!e.address.geoLocationAccurate&&(e.address.geoLocation={coordinates:[i.geoLocation.lng,i.geoLocation.lat],type:"Point"},r.address=e.address),Object.keys(r).length&&n.push(function(i){app.models.person.rawUpdateOne({_id:e.id},r,o).then(function(e){i(null,e)}).catch(function(o){t.push({model:app.models.person.modelName,recordId:e.id,error:o}),i(null,null)})})}),n.push(function(e){app.models.followUp.rawBulkUpdate({"address.locationId":i.id,"address.geoLocationAccurate":{$ne:!0},$or:[{"address.geoLocation.coordinates.0":{$ne:i.geoLocation.lng}},{"address.geoLocation.coordinates.1":{$ne:i.geoLocation.lat}}]},{"address.geoLocation":{coordinates:[i.geoLocation.lng,i.geoLocation.lat],type:"Point"}},o).then(function(o){o.notModified&&o.notModifiedIDs.forEach(function(e){t.push({model:app.models.followUp.modelName,recordId:e})}),e(null,o.modified)}).catch(function(o){t.push({model:app.models.followUp.modelName,error:o}),e(null,null)})}),new Promise(function(e,o){async.parallelLimit(n,10,function(i,n){if(i)return o(i);e({error:t,success:n.reduce(function(e,o){if(o)return isNaN(o)?e++:e+=o,e},0)})})})}).then(function(o){o.error.length?void 0!==o.success?t(app.utils.apiError.getError("BULK_UPDATE_PARTIAL_SUCCESS",{model:e.modelName,success:o.success,failed:o.error.length,errors:o.error})):t(app.utils.apiError.getError("BULK_UPDATE_FAILED",{model:e.modelName,failed:o.error.length,errors:o.error})):t(null,o.success)}).catch(t)}};