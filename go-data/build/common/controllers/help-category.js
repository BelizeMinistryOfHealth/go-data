"use strict";const app=require("../../server/server"),_=require("lodash");module.exports=function(e){app.utils.remote.disableRemoteMethods(e,["prototype.__delete__helpItems"]),e.prototype.approveHelpItem=function(e,t,r){app.models.helpItem.findOne({where:{categoryId:this.id,id:e}}).then(r=>{if(!r)throw app.utils.apiError.getError("MODEL_NOT_FOUND",{model:app.models.helpItem.modelName,id:e});return r.updateAttributes({approved:!0,approvedBy:t.accessToken.userId,approvedDate:Date.now()},t)}).then(e=>{r(null,e)}).catch(r)},e.searchHelpCategory=function(e,t,r){e=e||{};const o=_.get(e,"where.token",{});o&&delete e.where.token,app.models.languageToken.find(app.utils.remote.mergeFilters({where:o},{where:{languageId:{inq:["english_us",t.remotingContext.req.authData.user.languageId]}}})).then(t=>{let o=t.map(e=>e.token);app.models.helpCategory.find(app.utils.remote.mergeFilters({where:{or:[{name:{inq:o}},{description:{inq:o}}]}},e)).then(e=>r(null,e)).catch(r)})},e.searchHelpItem=function(e,t,r){e=e||{};const o=_.get(e,"where.token",{});o&&delete e.where.token,app.models.languageToken.find(app.utils.remote.mergeFilters({where:o},{where:{languageId:{inq:["english_us",t.remotingContext.req.authData.user.languageId]}}})).then(t=>{e&&!_.isEmpty(e.order)||((e=e||{}).order=[...(app.models.helpCategory.defaultOrder||[]).map(e=>`category.${e}`),...app.models.helpItem.defaultOrder]);let o=t.map(e=>e.token);app.models.helpItem.findAggregate(app.utils.remote.mergeFilters({where:{or:[{title:{inq:o}},{content:{inq:o}}]}},e)).then(e=>r(null,e)).catch(r)})},e.beforeRemote("find",function(e,t,r){e.args.filter&&!_.isEmpty(e.args.filter.order)||(e.args.filter=e.args.filter||{},e.args.filter.order=app.models.helpCategory.defaultOrder),r()}),e.beforeRemote("prototype.__get__helpItems",function(e,t,r){e.args.filter&&!_.isEmpty(e.args.filter.order)||(e.args.filter=e.args.filter||{},e.args.filter.order=app.models.helpCategory.defaultOrder),r()})};