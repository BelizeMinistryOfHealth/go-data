"use strict";const _=require("lodash"),app=require("../../server"),Role=app.models.role,User=app.models.user,rolesMap=require("./defaultRoles"),async=require("async"),defaultAdmin={id:"sys_admin",firstName:"System",lastName:"Administrator",email:"admin@who.int",password:"admin",languageId:"english_us",passwordChange:!0},defaultAdminRoles={ROLE_SYSTEM_ADMINISTRATOR:!0,ROLE_USER_MANAGER:!0};function run(e){let s=[];_.each(rolesMap||[],(e,i)=>{defaultAdminRoles[e.id]&&s.push({name:i,role:e})}),Role.find({where:{_id:{in:s.map(e=>e.role.id)}}}).then(function(e){const i={};(e||[]).forEach(e=>{i[e.id]=e});const r=[];return s.forEach(e=>{if(i[e.role.id]){let s=e.role.permissionIds.length===i[e.role.id].permissionIds.length;s&&i[e.role.id].permissionIds.forEach(function(i){-1===e.role.permissionIds.indexOf(i)&&(s=!1)}),s||r.push(s=>{console.warn(`Role '${e.role.id}' is missing some default permissions, it will be updated`),i[e.role.id].updateAttributes({permissionIds:e.role.permissionIds.filter(e=>-1!==Role.allAllowedPermissions.indexOf(e))}).then(()=>{console.warn(`Role '${e.role.id}' updated`),s()}).catch(s)})}else r.push(s=>{console.warn(`Could not find '${e.role.id}' role, it will be re-created`),Role.create({id:e.role.id,name:e.role.newName?e.role.newName:e.name,description:e.role.description,permissionIds:e.role.permissionIds}).then(()=>{console.warn(`Role '${e.role.id}' created`),s()}).catch(s)})}),r.length<1?s:new Promise((e,i)=>{async.parallelLimit(r,10,function(r){if(r)return i(r);e(s)})})}).then(function(){return User.findOne({where:{email:defaultAdmin.email}}).then(function(e){return e?Promise.all([e.updateAttributes({roleIds:_.uniq(e.roleIds.concat(s.map(e=>e.role.id)))}),e.updateAttributes({password:defaultAdmin.password,passwordChange:!0},{skipOldPasswordCheck:!0,skipSamePasswordCheck:!0})]):(console.warn("Could not find default system admin user, it will be re-created"),User.create(Object.assign(defaultAdmin,{roleIds:s.map(e=>e.role.id)})))})}).then(function(){console.log("Administrative password was reset"),e()}).catch(e)}module.exports=run;