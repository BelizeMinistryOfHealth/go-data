"use strict";const _=require("lodash");module.exports=function(e){e.remotes().phases.addAfter("authentication-context","device-register").use(function(r,t){const i=_.get(r,"req.authData.credentials.clientId"),a=_.get(r,"req.authData.client");let n,c=_.get(r,"req.headers.device-info");if(void 0===i||void 0===c)return t();try{c=JSON.parse(c),n=c.id}catch(i){r.req.logger.error(i),t(e.utils.apiError.getError("READ_DEVICE_INFORMATION_FAILURE",{error:i.message}))}e.models.device.findOne({where:{physicalDeviceId:n}}).then(function(r){return r?r.updateAttributes({lastSeen:new Date}):e.models.device.create({physicalDeviceId:n,os:c.os,manufacturer:c.manufacturer,model:c.model,name:c.name||a.name,description:c.description||`${a.credentials.clientId}/${a.credentials.clientSecret}`})}).then(function(e){_.set(r,"req.authData.device",e),t()}).catch(function(i){r.req.logger.error(i),t(e.utils.apiError.getError("SAVE_DEVICE_INFORMATION_FAILURE",{error:i.message}))})})};