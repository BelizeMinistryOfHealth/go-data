"use strict";const async=require("async");module.exports=function(e){e.remotes().phases.addAfter("request-response-logger","authentication-context").use(function(t,s){if(t.req&&t.req.accessToken&&t.req.accessToken.userId){let r=t.req.accessToken;return e.models.user.findById(r.userId).then(function(r){if(!r)return s();t.req.authData={user:r.toJSON(),userInstance:r},async.parallel([s=>{e.models.role.find({where:{id:{inq:r.roleIds}}}).then(e=>(t.req.authData.user.roles=e,t.req.authData.user.permissionsList=e.reduce((e,t)=>e.concat(t.permissionIds),[]),s(null))).catch(s)}],e=>s(e))}).catch(s)}if(t.req.headers.authorization){let r=t.req.headers.authorization.split(" ");if(2===r.length){let[n,a]=r;if(/^Basic$/i.test(n)){let r=Buffer.from(a,"base64").toString(),[n,i]=r.split(":");return e.models.systemSettings.findOne().then(e=>{let r=e.toJSON().clientApplications,a=r.findIndex(e=>e.credentials&&e.credentials.clientId===n);return-1!==a&&(t.req.authData={credentials:{clientId:n,clientSecret:i},client:r[a]}),s()}).catch(s)}if(/^Bearer$/i.test(n))return e.models.accessToken.resolve(e.models.accessToken.getIdForRequest(t.req),(r,n)=>r?s(r):(t.req.accessToken=n,e.models.user.findById(n.userId).then(function(r){if(!r)return s();t.req.authData={user:r.toJSON(),userInstance:r},async.parallel([s=>{e.models.role.find({where:{id:{inq:r.roleIds}}}).then(e=>(t.req.authData.user.roles=e,t.req.authData.user.permissionsList=e.reduce((e,t)=>e.concat(t.permissionIds),[]),s(null))).catch(s)}],e=>s(e))}).catch(s)))}}return s()})};