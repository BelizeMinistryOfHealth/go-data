"use strict";const schemaFolder="/../../common/validationSchemas/",app=require("../../server/server"),fs=require("fs"),existingSchemas=[];!function e(s){fs.readdirSync(s).forEach(r=>{r.endsWith(".json")?existingSchemas.push(require(s+r)):fs.lstatSync(s+r).isDirectory()&&e(s+r+"/")})}(__dirname+schemaFolder);const prepareValidator=function(){const e=new(require("ajv"))({allErrors:!0});return registerSchemas(e),e},registerSchemas=function(e){existingSchemas.forEach(s=>{e.addSchema(s)})};module.exports=function(e){const s=e.modelName,r=e.definition.settings.validationSchemas;Object.keys(r).forEach(a=>{e.beforeRemote(a,function(e,t,i){const o=prepareValidator();if(o.validate(r[a],e.req.body))i();else{let e={details:[],codes:{},messages:{}};o.errors.forEach(r=>{let a=r.dataPath?r.dataPath.substring(1):"";r.params.missingProperty?a+=a?"."+r.params.missingProperty:r.params.missingProperty:r.params.additionalProperty&&(a+=a?"."+r.params.additionalProperty:r.params.additionalProperty),e.details.push(`${s}${r.dataPath} ${r.message}`),e.codes[a]=[r.keyword],e.messages[a]="required"===r.keyword?["can't be blank"]:[r.message]}),i(app.utils.apiError.getError("VALIDATION_ERROR",{model:s,details:Object.assign({toString:function(){return e.details.join(", ")}},{codes:e.codes,messages:e.messages})}))}})})};