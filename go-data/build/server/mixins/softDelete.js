"use strict";const _=require("lodash");function isMonitoredModel(e){return-1===["auditLog","extendedPersistedModel","person"].indexOf(e.modelName)}module.exports=function(e){function t(e,t){return"function"==typeof this.callback?this.callback(e,t):e?Promise.reject(e):t}e.defineProperty("deleted",{type:Boolean,required:!0,default:!1,readOnly:!0,safeForImport:!0}),e.defineProperty("deletedAt",{type:Date,readOnly:!0,safeForImport:!0}),e.prototype.undoDelete=function(t,n){"function"==typeof t&&void 0===n&&(n=t,t={options:{}});let o={deleted:!1,deletedAt:null};t&&t.extraProps&&Object.assign(o,t.extraProps);const r=this;let d={model:e,instance:r,where:{id:r.id},options:t};e.notifyObserversOf("before restore",d,function(i){if(i)return n(i);r.isValid=function(e){e(!0)},r.updateAttributes(o,t,function(t,o){if(t)return n(t);e.notifyObserversOf("after restore",d,function(e){n(e,o)})})})},e.observe("before save",function(t,n){if(isMonitoredModel(e)&&t.data)if(t.currentInstance){if(t.data.deleted&&t.data.deleted!==t.currentInstance.deleted)return _.set(t,`options._instance[${t.currentInstance.id}].softDeleteEvent`,!0),e.notifyObserversOf("before delete",t,n)}else if(t.data.deleted&&t.where)return _.set(t,`options._instance[batch_${e.modelName}].softDeleteEvent`,!0),e.notifyObserversOf("before delete",t,n);return n()}),e.observe("after save",function(t,n){return isMonitoredModel(e)&&(t.instance&&_.get(t,`options._instance[${t.instance.id}].softDeleteEvent`)||_.get(t,`options._instance[batch_${e.modelName}].softDeleteEvent`))?e.notifyObserversOf("after delete",t,n):n()}),e.destroyAll=function(n,o,r){void 0===r&&"function"==typeof o&&(r=o);let d=t.bind({callback:r});const i=e.updateAll(n,{deleted:!0,deletedAt:new Date}).then(function(e){return d(null,e)}).catch(function(e){return d(e)});if("function"!=typeof r)return i},e.remove=e.destroyAll,e.deleteAll=e.destroyAll,e.destroyById=function(n,o,r){let d=!0;void 0===r&&"function"==typeof o&&(r=o,d=!1);let i=t.bind({callback:r});const l=e.findById(n).then(function(e){if(e){e.isValid=function(e){e(!0)};let t={deleted:!0};return d&&o._sync&&e.deletedAt||(t.deletedAt=new Date),e.updateAttributes(t,d?o:{}).then(function(){return{count:1}})}return{count:0}}).then(function(e){return i(null,e)}).catch(function(e){return i(e)});if("function"!=typeof r)return l},e.removeById=e.destroyById,e.deleteById=e.destroyById,e.prototype.destroy=function(e,n){let o=!0;void 0===n&&"function"==typeof e?(n=e,o=!1):e||(o=!1);let r=t.bind({callback:n});this.isValid=function(e){e(!0)};let d={deleted:!0};o&&e._sync&&this.deletedAt||(d.deletedAt=new Date),o&&e.extraProps&&Object.assign(d,e.extraProps);const i=this.updateAttributes(d,o?e:{}).then(function(){return{count:1}}).then(function(e){return r(null,e)}).catch(function(e){return r(e)});if("function"!=typeof n)return i},e.prototype.remove=e.prototype.destroy,e.prototype.delete=e.prototype.destroy;const n={deleted:{neq:!0}},o=e.findOrCreate;e.findOrCreate=function(t={},...r){return t.where||(t.where={}),t.deleted||(t.where={and:[t.where,n]}),o.call(e,t,...r)};const r=e.find;e.find=function(t={},...o){return t.where||(t.where={}),t.deleted||(t.where={and:[t.where,n]}),r.call(e,t,...o)};const d=e.findOne;e.findOne=function(t={},...o){return t.where||(t.where={}),t.deleted||(t.where={and:[t.where,n]}),d.call(e,t,...o)};const i=e.count;e.count=function(t={},...o){let r=(t?JSON.stringify(t):"").indexOf('"deleted":')>-1;t.includeDeletedRecords&&(delete t.includeDeletedRecords,r=!0);const d=r?t:{and:[t,n]};return i.call(e,d,...o)};const l=e.update;e.update=e.updateAll=function(t={},...o){const r={and:[t,n]};return l.call(e,r,...o)}};