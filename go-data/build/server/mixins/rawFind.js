"use strict";const _=require("lodash"),app=require("../server"),Timer=require("../../components/Timer"),uuid=require("uuid");module.exports=function(e){let o=_.get(e,"definition.settings.mongodb.collection");o||(o=e.modelName);const i=_.get(e,"definition.settings.scope.where");e.rawFind=function(e,t={}){t=t||{},e=e||{};const r=uuid.v4(),n=new Timer;n.start(),i&&(e={$and:[i,e]}),e=app.utils.remote.convertLoopbackFilterToMongo(e),t.includeDeletedRecords||(e={$and:[e,{deleted:{$ne:!0}}]}),app.logger.debug(`[QueryId: ${r}] Performing MongoDB request on collection '${o}': find ${JSON.stringify(e)}, ${t.projection?JSON.stringify({projection:t.projection}):""}`);let d=app.dataSources.mongoDb.connector.collection(o).find(e,{projection:t.projection});return(t.order||t.sort)&&(d=d.sort(t.order||t.sort)),t.skip&&(d=d.skip(t.skip)),t.limit&&(d=d.limit(t.limit)),d.toArray().then(function(e){return app.logger.debug(`[QueryId: ${r}] MongoDB request completed after ${n.getElapsedMilliseconds()} msec`),e.forEach(function(e){e.id=e._id,delete e._id}),e})},e.rawFindWithLoopbackFilter=function(o={},i={}){let t=o.where||{};return o.skip&&(i.skip=o.skip),o.limit&&(i.limit=o.limit),o.fields&&(i.projection={},o.fields.forEach(e=>i.projection[e]=1)),o.order&&(i.sort={},o.order.forEach(e=>{let o=e.split(" "),t=o[0];i.sort[t]=o[1]&&-1!==["desc","DESC"].indexOf(o[1])?-1:1})),e.rawFind(t,i)}};