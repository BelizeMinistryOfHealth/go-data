"use strict";const app=require("../server"),_=require("lodash");function getSourceAndTargetFromContext(e){const t={};return e.instance?("function"==typeof e.instance.toJSON?t.source=e.instance.toJSON():t.source=e.instance,t.target=e.instance):(t.source=e.data,t.target=e.data),t}module.exports=function(e){function t(t){const a=getSourceAndTargetFromContext(t);(e.nestedGeoPoints||[]).forEach(function(e){let t=app.utils.helpers.getReferencedValue(a.source,e);Array.isArray(t)||(t=[t]),t.forEach(function(e){e.value&&e.value.coordinates&&null!=e.value.coordinates[0]&&null!=e.value.coordinates[1]?_.set(a.target,e.exactPath,{lat:e.value.coordinates[1],lng:e.value.coordinates[0]}):e.value&&null!=e.value.lat&&null!=e.value.lng?_.set(a.target,e.exactPath,{lat:e.value.lat,lng:e.value.lng}):_.set(a.target,e.exactPath,void 0)})})}function a(t){const a=getSourceAndTargetFromContext(t);(e.nestedGeoPoints||[]).forEach(function(e){let t=app.utils.helpers.getReferencedValue(a.source,e);Array.isArray(t)||(t=[t]),t.forEach(function(e){if(e.value&&null!=e.value.lng&&null!=e.value.lat){let t=e.value.lat,n=e.value.lng;if("string"==typeof t)try{t=parseFloat(t)}catch(e){}if("string"==typeof n)try{n=parseFloat(n)}catch(e){}_.set(a.target,e.exactPath,{coordinates:[n,t],type:"Point"})}else e.value&&e.value.coordinates&&null!=e.value.coordinates[0]&&null!=e.value.coordinates[1]?_.set(a.target,e.exactPath,{coordinates:e.value.coordinates,type:"Point"}):function(e,t){const a=t.lastIndexOf(".");if(a>-1){const n=_.get(e,t.substring(0,a));n&&n.unsetAttribute?n.unsetAttribute(t.substring(a+1)):_.unset(e,t)}else _.unset(e,t)}(a.target,e.exactPath)})})}e.nestedGeoPoints&&e.nestedGeoPoints.length&&(e.observe("before save",function(e,t){a(e),t()}),e.observe("after save",function(e,a){t(e),a()}),e.observe("loaded",function(e,a){t(e),a()}),e.prepareDataForDB=a,e.prepareDataForRead=t)};